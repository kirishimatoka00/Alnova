<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nova 12.15 - Stability Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { slate: { 925: '#0f172a' } },
                    animation: { 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'spin-slow': 'spin 2s linear infinite' }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        .dot-flashing {
            position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #9880ff; color: #9880ff;
            animation: dot-flashing 1s infinite linear alternate; animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: ""; display: inline-block; position: absolute; top: 0; width: 6px; height: 6px; border-radius: 5px; background-color: #9880ff; color: #9880ff; animation: dot-flashing 1s infinite alternate;
        }
        .dot-flashing::before { left: -10px; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { background-color: #9880ff; } 50%, 100% { background-color: rgba(152, 128, 255, 0.2); } }
        .msg-content a, #doc-content-area a { color: #60a5fa; text-decoration: underline; word-break: break-all; cursor: pointer; }
        .msg-content img, #doc-content-area img { max-width: 100%; height: auto; border-radius: 8px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.1); }
        .msg-content p, #doc-content-area div { margin-bottom: 0.5em; line-height: 1.6; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .msg-group:hover .msg-actions { opacity: 1; }
        .msg-actions { opacity: 0; transition: opacity 0.2s; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans overflow-hidden selection:bg-blue-500/30">

    <div class="flex h-[100dvh] w-full">
        <!-- Sidebar -->
        <aside class="hidden md:flex flex-col w-64 bg-slate-900 border-r border-slate-800 p-6 flex-shrink-0">
            <div class="flex items-center space-x-3 mb-10 px-2">
                <div class="w-10 h-10 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i class="ph-bold ph-infinity text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white tracking-wide">NOVA</h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider">Stability 12.15</p>
                </div>
            </div>
            <nav class="flex-1 space-y-2">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg transition-all"><i class="ph ph-chats-circle text-xl"></i><span class="font-medium">åŠ©ç†å°è©±</span></button>
                <button onclick="switchTab('schedule')" id="nav-schedule" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all"><i class="ph ph-calendar-check text-xl"></i><span class="font-medium">è¡Œç¨‹ç®¡ç†</span></button>
                <button onclick="switchTab('notes')" id="nav-notes" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all"><i class="ph ph-notebook text-xl"></i><span class="font-medium">ç­†è¨˜/æ–‡ä»¶</span></button>
            </nav>
            <div class="mt-auto space-y-3">
                <button onclick="openSettings()" class="flex items-center space-x-2 text-xs text-slate-500 hover:text-slate-300 w-full px-2"><i class="ph ph-gear"></i><span>è¨­å®š & API</span></button>
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                    <div class="flex items-center space-x-2"><i id="status-icon" class="ph-fill ph-globe text-blue-400 text-lg"></i><span id="status-name" class="font-bold text-sm">Gemini</span></div>
                    <p id="model-version-display" class="text-[10px] text-slate-500 mt-1">Ready</p>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-slate-950 overflow-hidden min-h-0">
            <!-- Mobile Header -->
            <div class="md:hidden flex items-center justify-between p-3 bg-slate-900 border-b border-slate-800 z-30 shrink-0">
                <div class="flex items-center space-x-2"><i class="ph-bold ph-infinity text-blue-500 text-xl"></i><span class="font-bold text-white">Nova</span></div>
                <div class="flex items-center space-x-2 bg-slate-800/50 px-2 py-1 rounded-lg border border-slate-700/50 cursor-pointer active:scale-95 transition-transform" onclick="cycleManualLocation()">
                    <i id="mobile-weather-icon" class="ph-fill ph-navigation-arrow text-blue-400"></i><span id="mobile-weather-temp" class="text-xs font-bold text-white">æ›´æ–°</span>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="openSettings()"><i class="ph ph-gear text-slate-400 text-xl"></i></button>
                    <button onclick="toggleMobileMenu()"><i class="ph ph-list text-white text-2xl"></i></button>
                </div>
            </div>

            <!-- Mobile Menu -->
            <div id="mobile-menu" class="hidden md:hidden fixed inset-0 z-40 bg-slate-950/95 pt-20 px-6 backdrop-blur-md">
                <nav class="space-y-4">
                    <button onclick="switchTab('dashboard'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl bg-slate-800 text-white"><i class="ph ph-chats-circle text-xl"></i><span>åŠ©ç†å°è©±</span></button>
                    <button onclick="switchTab('schedule'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800"><i class="ph ph-calendar-check text-xl"></i><span>è¡Œç¨‹ç®¡ç†</span></button>
                    <button onclick="switchTab('notes'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800"><i class="ph ph-notebook text-xl"></i><span>ç­†è¨˜/æ–‡ä»¶</span></button>
                </nav>
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-slate-950/90 backdrop-blur-sm flex items-center justify-center p-4">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-md shadow-2xl">
                    <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white">è¨­å®š</h3><button onclick="closeSettings()"><i class="ph ph-x text-2xl text-slate-400"></i></button></div>
                    <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                        <div class="bg-gradient-to-r from-blue-900/30 to-indigo-900/30 p-4 rounded-xl border border-blue-500/50 shadow-inner">
                            <label class="block text-xs text-blue-300 mb-2 font-bold flex items-center gap-2"><i class="ph-fill ph-file-doc"></i> Google Docs æ ¸å¿ƒ (Apps Script)</label>
                            <input type="text" id="key-doc-url" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-xs focus:border-blue-500 outline-none mb-2" placeholder="https://script.google.com/macros/s/...">
                            <div class="flex items-center justify-between">
                                <span id="doc-monitor-status" class="text-[10px] text-slate-500">æœªè¨­å®š</span>
                                <button onclick="testDocConnection()" class="text-[10px] bg-blue-600 px-3 py-1 rounded text-white hover:bg-blue-500">æ¸¬è©¦é€£ç·š</button>
                            </div>
                            <details class="mt-3 group">
                                <summary class="text-[10px] text-yellow-400 cursor-pointer hover:text-yellow-300 font-bold flex items-center gap-1"><i class="ph-bold ph-warning"></i> é»æ­¤æ›´æ–°ç¨‹å¼ç¢¼ (Apps Script 5.0 - å¿…æ›´)</summary>
                                <div class="text-[10px] text-slate-400 mt-2 p-3 bg-slate-950 rounded border border-slate-700 leading-relaxed">
                                    <p class="mb-2">è«‹è¤‡è£½ä¸‹æ–¹æ‰€æœ‰ç¨‹å¼ç¢¼ï¼Œå–ä»£æ‚¨ Google Apps Script å…§çš„å…§å®¹ï¼Œä¸¦åŸ·è¡Œ <b>ã€Œéƒ¨ç½²ã€>ã€Œç®¡ç†éƒ¨ç½²ã€>ã€Œç·¨è¼¯ã€>ã€Œæ–°ç‰ˆæœ¬ã€>ã€Œéƒ¨ç½²ã€</b>ã€‚</p>
                                    <pre class="bg-slate-900 p-2 rounded text-blue-300 overflow-x-auto text-[9px] select-all border border-slate-800 font-mono">
function doGet(e) {
  try { return ContentService.createTextOutput(DocumentApp.getActiveDocument().getBody().getText()); } 
  catch(e) { return ContentService.createTextOutput("Error"); }
}
function doPost(e) {
  var d = JSON.parse(e.postData.contents);
  var body = DocumentApp.getActiveDocument().getBody();
  if (d.type === 'clear') { body.clear(); return ContentService.createTextOutput("Cleared"); }
  if (d.type === 'scrape_and_log') {
    try {
      body.clear();
      var html = UrlFetchApp.fetch(d.url).getContentText();
      var text = html.replace(/&lt;script[^&gt;]*&gt;([\s\S]*?)&lt;\/script&gt;/gmi, "").replace(/&lt;style[^&gt;]*&gt;([\s\S]*?)&lt;\/style&gt;/gmi, "").replace(/&lt;[^&gt;]*&gt;/g, " ").replace(/\s+/g, " ").trim().substring(0, 50000);
      body.appendParagraph("ğŸŒ ä¾†æº: " + d.url);
      body.appendParagraph("ğŸ“… æ™‚é–“: " + new Date().toLocaleString());
      body.appendParagraph("------------------------------------------------");
      body.appendParagraph(text);
      return ContentService.createTextOutput(text);
    } catch (err) { return ContentService.createTextOutput("Error: " + err.toString()); }
  }
  if (d.type === 'text') body.appendParagraph(d.content);
  return ContentService.createTextOutput("OK");
}</pre>
                                </div>
                            </details>
                        </div>
                        <div class="space-y-3 pt-2">
                            <div class="p-3 rounded-lg border border-pink-900/30 bg-pink-900/10"><label class="block text-xs text-pink-400 mb-1">Zeabur / Custom API</label><input type="text" id="key-zeabur-url" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-pink-500 outline-none mb-1" placeholder="URL"><input type="password" id="key-zeabur-key" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-pink-500 outline-none" placeholder="Key (Optional)"></div>
                            <div><label class="block text-xs text-blue-400 mb-1">Gemini API Key</label><input type="password" id="key-gemini" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-purple-400 mb-1">OpenRouter Key</label><input type="password" id="key-openrouter" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-purple-500 outline-none"></div>
                            <div><label class="block text-xs text-orange-400 mb-1">Cerebras API Key</label><input type="password" id="key-cerebras" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-orange-500 outline-none"></div>
                            <div><label class="block text-xs text-emerald-400 mb-1">OpenAI API Key</label><input type="password" id="key-openai" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-emerald-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-300 mb-1">Grok API Key</label><input type="password" id="key-grok" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-slate-500 outline-none"></div>
                            <select id="model-openrouter-select" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs text-white outline-none focus:border-purple-500 mt-1"><option value="deepseek/deepseek-r1:free">DeepSeek R1</option><option value="meta-llama/llama-3.3-70b-instruct:free">Llama 3.3</option><option value="google/gemini-2.0-flash-lite-preview-02-05:free">Gemini 2.0 Flash</option><option value="anthropic/claude-3.5-sonnet">Claude 3.5</option></select>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3"><button onclick="closeSettings()" class="px-4 py-2 text-slate-400 text-sm">å–æ¶ˆ</button><button onclick="saveKeys()" class="px-6 py-2 bg-blue-600 text-white rounded-lg">å„²å­˜</button></div>
                </div>
            </div>

            <div id="view-dashboard" class="flex flex-col lg:flex-row h-full w-full relative min-h-0">
                <div class="flex-1 flex flex-col h-full min-w-0 relative">
                    <div class="p-3 border-b border-slate-800 bg-slate-900/50 backdrop-blur-sm flex justify-between items-center shrink-0 overflow-x-auto no-scrollbar">
                         <div class="flex items-center space-x-2 mr-4">
                            <span id="web-search-badge" class="hidden md:flex items-center space-x-1 text-[10px] bg-blue-900/30 text-blue-400 border border-blue-500/30 px-2 py-0.5 rounded-full"><i class="ph-bold ph-globe"></i><span>é€£ç¶²æœå°‹</span></span>
                            <span id="doc-monitor-badge" class="hidden items-center space-x-1 text-[10px] bg-emerald-900/30 text-emerald-400 border border-emerald-500/30 px-2 py-0.5 rounded-full animate-pulse"><i class="ph-bold ph-arrows-clockwise"></i><span>Docs ç›£æ§ä¸­</span></span>
                            <button onclick="clearChatHistory()" class="text-[10px] text-slate-500 hover:text-red-400 flex items-center space-x-1 border border-slate-700 px-2 py-0.5 rounded-lg transition-colors"><i class="ph-bold ph-trash"></i><span>æ¸…ç©ºå°è©±</span></button>
                         </div>
                         <div class="flex space-x-1">
                            <button onclick="setModel('gemini')" class="model-pill px-3 py-1 rounded-lg text-[10px] font-bold bg-blue-600 text-white transition-all whitespace-nowrap" data-model="gemini">Gemini</button>
                            <button onclick="setModel('openrouter')" class="model-pill px-3 py-1 rounded-lg text-[10px] font-bold bg-slate-800 text-slate-400 transition-all whitespace-nowrap" data-model="openrouter">OpenRouter</button>
                            <button onclick="setModel('zeabur')" class="model-pill px-3 py-1 rounded-lg text-[10px] font-bold bg-slate-800 text-slate-400 transition-all whitespace-nowrap" data-model="zeabur">Zeabur</button>
                            <button onclick="setModel('cerebras')" class="model-pill px-3 py-1 rounded-lg text-[10px] font-bold bg-slate-800 text-slate-400 transition-all whitespace-nowrap" data-model="cerebras">Cerebras</button>
                            <button onclick="setModel('gpt')" class="model-pill px-3 py-1 rounded-lg text-[10px] font-bold bg-slate-800 text-slate-400 transition-all whitespace-nowrap" data-model="gpt">GPT</button>
                         </div>
                    </div>
                    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 scrollbar-thin scrollbar-thumb-slate-700"></div>
                    <div class="p-4 bg-slate-900 border-t border-slate-800 shrink-0 z-20 pb-[calc(1rem+env(safe-area-inset-bottom))]">
                        <div id="input-wrapper" class="flex items-center bg-slate-950 rounded-xl px-2 py-2 border border-slate-700 focus-within:border-blue-500 transition-colors">
                            <button id="search-toggle-btn" onclick="toggleSearch()" class="p-3 rounded-lg text-slate-500 hover:text-blue-400 hover:bg-slate-800 transition-all flex-shrink-0 mr-1" title="åˆ‡æ›æœå°‹ (Gemini Only)"><i id="search-icon" class="ph-bold ph-globe text-xl"></i></button>
                            <button id="voice-btn" onclick="toggleVoice()" class="p-3 mr-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-all active:scale-95 flex-shrink-0"><i id="voice-icon" class="ph-bold ph-microphone text-xl"></i></button>
                            <input type="text" id="user-input" placeholder="è²¼ä¸Šç¶²å€è‡ªå‹•åˆ†æï¼Œæˆ–è¼¸å…¥ã€Œæœå°‹ï¼šé—œéµå­—ã€..." class="flex-1 bg-transparent border-none focus:ring-0 text-white outline-none h-full" onkeydown="handleEnter(event)">
                            <button onclick="handleSendMessage()" id="send-btn" class="ml-2 p-3 rounded-lg text-white bg-blue-600 hover:opacity-90 flex-shrink-0 transition-all"><i id="send-icon" class="ph-bold ph-paper-plane-right"></i></button>
                        </div>
                        <div id="search-hint" class="text-[10px] text-blue-400 mt-2 text-center hidden">ğŸŒ å·²é–‹å•Ÿé€£ç¶²æœå°‹ (Gemini)</div>
                    </div>
                </div>
                <div class="hidden lg:flex w-80 bg-slate-900 flex-col p-6 space-y-6 border-l border-slate-800 overflow-y-auto shrink-0">
                    <div class="bg-gradient-to-br from-indigo-900 to-slate-800 rounded-3xl p-6 text-white shadow-lg border border-slate-700 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/20 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start">
                                <div><h3 class="text-slate-300 text-xs font-bold uppercase mb-1">ç›®å‰å¤©æ°£</h3><div class="flex items-center space-x-2 cursor-pointer hover:opacity-80 transition-opacity" onclick="cycleManualLocation()"><i class="ph-fill ph-map-pin text-blue-400"></i><span id="location-name" class="text-lg font-bold text-white border-b border-dashed border-slate-500">æœªå®šä½</span></div></div><i id="weather-icon" class="ph-fill ph-cloud-sun text-4xl text-yellow-400"></i>
                            </div>
                            <div class="mt-4 flex items-end space-x-2"><span id="weather-temp" class="text-5xl font-bold">--Â°</span><span id="weather-desc" class="text-slate-300 text-sm mb-2">--</span></div>
                        </div>
                    </div>
                    <div class="bg-slate-950 rounded-2xl p-5 border border-slate-800">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-200 text-sm flex items-center gap-2"><i class="ph-fill ph-calendar-check text-blue-500"></i>è¿‘æœŸä»»å‹™</h3><button onclick="switchTab('schedule')" class="text-xs text-blue-400">ç®¡ç†</button></div>
                        <div id="mini-todo-list" class="space-y-2"></div>
                    </div>
                    <div class="bg-slate-950 rounded-2xl p-5 border border-slate-800">
                         <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-200 text-sm flex items-center gap-2"><i class="ph-fill ph-notebook text-emerald-500"></i>æœ€æ–°ç­†è¨˜</h3><button onclick="switchTab('notes')" class="text-xs text-blue-400">æŸ¥çœ‹</button></div>
                        <div id="mini-note-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div id="view-schedule" class="hidden flex-col h-full w-full p-6 overflow-y-auto"><div class="max-w-3xl mx-auto w-full"><header class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">è¡Œç¨‹ç®¡ç†</h2><button onclick="addTodoManually()" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2"><i class="ph-bold ph-plus"></i><span>æ–°å¢</span></button></header><div id="full-todo-list" class="space-y-3"></div></div></div>
            <div id="view-notes" class="hidden flex-col h-full w-full p-6 overflow-y-auto"><div class="max-w-5xl mx-auto w-full"><header class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">ç­†è¨˜/æ–‡ä»¶</h2><button onclick="addNoteManually()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2"><i class="ph-bold ph-plus"></i><span>æ–°å¢</span></button></header><div id="full-note-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div></div>
        </main>
    </div>

    <script>
        const appState = {
            currentModel: 'gemini', detectedGeminiModel: null,
            openRouterModel: localStorage.getItem('nova_or_model') || 'deepseek/deepseek-r1:free',
            docMonitorUrl: localStorage.getItem('nova_doc_url') || '',
            zeaburUrl: localStorage.getItem('nova_key_zeabur_url') || '',
            zeaburKey: localStorage.getItem('nova_key_zeabur_key') || '',
            messages: JSON.parse(localStorage.getItem('nova_messages') || '[]'),
            todos: JSON.parse(localStorage.getItem('nova_todos') || '[]'),
            notes: JSON.parse(localStorage.getItem('nova_notes') || '[]'),
            weather: { temp: '--', condition: 'cloudy', humidity: '--', wind: '--', loc: 'æœªå®šä½' },
            keys: { 
                gemini: localStorage.getItem('nova_key_gemini')||'', 
                cerebras: localStorage.getItem('nova_key_cerebras')||'', 
                openrouter: localStorage.getItem('nova_key_openrouter')||'',
                openai: localStorage.getItem('nova_key_openai')||'', 
                grok: localStorage.getItem('nova_key_grok')||'' 
            },
            isThinking: false, isListening: false, isSearchEnabled: false,
            manualLocIndex: 0,
            manualLocs: [{name: "å°åŒ—", lat: 25.0330, lon: 121.5654}, {name: "å°ä¸­", lat: 24.1477, lon: 120.6736}, {name: "é«˜é›„", lat: 22.6273, lon: 120.3014}]
        };
        const MODEL_CONFIG = {
            gemini: { name: 'Gemini', color: 'text-blue-400', bg: 'bg-blue-600', icon: 'ph-globe' },
            openrouter: { name: 'OpenRouter', color: 'text-purple-400', bg: 'bg-purple-600', icon: 'ph-infinity' },
            cerebras: { name: 'Cerebras', color: 'text-orange-400', bg: 'bg-orange-600', icon: 'ph-rocket-launch' },
            gpt: { name: 'ChatGPT', color: 'text-emerald-400', bg: 'bg-emerald-600', icon: 'ph-cpu' },
            grok: { name: 'Grok', color: 'text-slate-100', bg: 'bg-slate-600', icon: 'ph-lightning' },
            zeabur: { name: 'Zeabur', color: 'text-pink-400', bg: 'bg-pink-600', icon: 'ph-plant' }
        };

        function saveMessages() { localStorage.setItem('nova_messages', JSON.stringify(appState.messages)); }
        function saveData() { localStorage.setItem('nova_todos', JSON.stringify(appState.todos)); localStorage.setItem('nova_notes', JSON.stringify(appState.notes)); }
        function getTime() { return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
        function formatMessage(text) { if (!text) return ''; let safe = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); safe = safe.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-bold">$1</strong>'); safe = safe.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" class="text-blue-400 underline break-all">$1</a>'); return safe.replace(/\n/g, '<br>'); }
        function escapeHtml(t){return t?t.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">"):""}
        function getShortName(m) { if(m.includes('deepseek')) return 'DeepSeek R1'; if(m.includes('llama')) return 'Llama 3.3'; if(m.includes('claude')) return 'Claude 3.5'; if(m.includes('gemini')) return 'Gemini 2.0'; return 'OpenRouter'; }

        function renderAll() { renderMessages(); renderTodos(); renderNotes(); renderWeather(); }
        function renderMessages() { 
            const container = document.getElementById('chat-container');
            if(!container) return;
            container.innerHTML = appState.messages.map(msg => { 
                const isUser = msg.sender === 'user'; 
                const modelInfo = isUser ? null : MODEL_CONFIG[msg.model]; 
                let sourcesHTML = ''; 
                if (msg.sources?.length) sourcesHTML = `<div class="mt-3 pt-3 border-t border-slate-700/50"><p class="text-[10px] text-slate-400 mb-1 font-bold">ä¾†æºï¼š</p><div class="flex flex-wrap gap-2">${msg.sources.map((s,i)=>`<a href="${s.uri}" target="_blank" class="text-[10px] bg-slate-950/50 text-blue-400 px-2 py-1 rounded border border-slate-700/50 block truncate max-w-[150px]">${i+1}. ${s.title}</a>`).join('')}</div></div>`; 
                return `<div class="group flex ${isUser ? 'justify-end' : 'justify-start items-start space-x-3'} fade-in relative mb-4">
                    ${!isUser ? `<div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 mt-1 ${modelInfo?.bg||'bg-slate-700'}"><i class="ph-fill ${modelInfo?.icon||'ph-robot'} text-white text-sm"></i></div>` : ''}
                    <div class="msg-group relative max-w-[90%] md:max-w-[80%] rounded-2xl p-4 shadow-sm ${isUser ? 'bg-slate-800 text-white rounded-br-none' : 'bg-slate-900 border border-slate-800 text-slate-200 rounded-tl-none'}">
                        ${!isUser ? `<span class="text-[10px] font-bold uppercase mb-1 block ${modelInfo?.color||'text-slate-400'} opacity-80">${modelInfo?.name||'System'}${msg.model==='openrouter'?` (${getShortName(appState.openRouterModel)})`:''}</span>` : ''}
                        <div class="msg-content text-sm leading-relaxed">${formatMessage(msg.text)}</div>
                        ${sourcesHTML}
                        <p class="text-[10px] mt-2 text-right text-slate-500 opacity-60">${msg.time}</p>
                        <button onclick="deleteMessage(${msg.id})" class="msg-actions absolute top-2 right-2 p-1 text-slate-500 hover:text-red-400 transition-colors bg-slate-950/50 rounded-full"><i class="ph-bold ph-trash text-xs"></i></button>
                    </div>
                </div>`; 
            }).join(''); 
            container.scrollTop = container.scrollHeight; 
        }

        function renderThinkingState(show) { 
            const el = document.getElementById('thinking-indicator'); 
            const container = document.getElementById('chat-container');
            if(show && !el && container) container.insertAdjacentHTML('beforeend', `<div id="thinking-indicator" class="flex justify-start items-center space-x-3 fade-in"><div class="w-8 h-8 rounded-full flex items-center justify-center ${MODEL_CONFIG[appState.currentModel].bg}"><i class="ph-fill ${MODEL_CONFIG[appState.currentModel].icon} text-white text-sm"></i></div><div class="bg-slate-900 border border-slate-800 p-4 rounded-2xl rounded-tl-none"><div class="dot-flashing ml-2"></div></div></div>`); 
            else if(!show && el) el.remove(); 
        }

        // ... existing renders (todos, notes, weather, updateModelUI) ...
        function renderTodos() { 
            const el = document.getElementById('full-todo-list');
            if(!el) return;
            el.innerHTML=appState.todos.map(t=>`<div class="group bg-slate-900 p-4 rounded-xl border border-slate-800 flex justify-between hover:border-slate-600 transition-all slide-in"><div class="flex items-center space-x-4"><button onclick="toggleTodo(${t.id})" class="text-slate-500 hover:text-blue-400"><i class="ph${t.done?'-fill ph-check-circle text-green-500':' ph-circle'} text-2xl"></i></button><div><p class="text-base ${t.done?'line-through text-slate-600':'text-slate-200'}">${escapeHtml(t.text)}</p><span class="text-xs text-slate-500">${t.time}</span></div></div><button onclick="deleteTodo(${t.id})" class="text-slate-500 hover:text-red-400 p-2"><i class="ph ph-trash"></i></button></div>`).join('')||'<p class="text-slate-500 text-center mt-10">ç„¡ä»»å‹™</p>'; 
            const mini = document.getElementById('mini-todo-list');
            if(mini) mini.innerHTML=appState.todos.slice(0,3).map(t=>`<div class="flex items-center space-x-3 p-2 bg-slate-950/50 rounded-lg border border-slate-800/50"><div class="w-1.5 h-8 rounded-full ${t.done?'bg-green-500':'bg-blue-500'}"></div><div class="flex-1 min-w-0"><p class="text-xs truncate ${t.done?'line-through text-slate-600':'text-slate-300'}">${escapeHtml(t.text)}</p></div></div>`).join('')||'<p class="text-xs text-slate-500 text-center">ç„¡å¾…è¾¦</p>'; 
        }

        function renderNotes() { 
            const el = document.getElementById('full-note-list');
            if(!el) return;
            el.innerHTML=appState.notes.map(n=>`<div class="bg-slate-900 p-6 rounded-2xl border border-slate-800 hover:border-slate-600 flex flex-col h-48 relative overflow-hidden slide-in"><div class="flex justify-between mb-2"><h3 class="text-lg font-bold text-white truncate pr-2">${escapeHtml(n.title)}</h3><span class="text-xs text-slate-500 whitespace-nowrap">${n.date}</span></div><p class="text-slate-300 text-sm overflow-y-auto flex-1 scrollbar-thin">${escapeHtml(n.content)}</p><button onclick="deleteNote(${n.id})" class="absolute bottom-4 right-4 text-slate-600 hover:text-red-400"><i class="ph ph-trash text-lg"></i></button></div>`).join('')||'<p class="text-slate-500 text-center col-span-3 mt-10">ç„¡ç­†è¨˜</p>'; 
            const mini = document.getElementById('mini-note-list');
            if(mini) mini.innerHTML=appState.notes.slice(0,2).map(n=>`<div class="bg-slate-950/50 p-3 rounded-lg border border-slate-800/50 cursor-pointer hover:border-slate-700" onclick="switchTab('notes')"><h4 class="text-slate-300 text-xs font-bold mb-1 truncate">${escapeHtml(n.title)}</h4><p class="text-slate-500 text-[10px] line-clamp-1">${escapeHtml(n.content)}</p></div>`).join('')||'<p class="text-xs text-slate-500 text-center">ç„¡ç­†è¨˜</p>'; 
        }

        function renderWeather() { 
            const {temp,condition,humidity,wind,loc}=appState.weather; 
            let icon='ph-cloud',color='text-slate-400',desc='å¤šé›²'; 
            if(condition==='sunny'){icon='ph-sun';color='text-yellow-400';desc='æ™´æœ—';} 
            if(condition==='rainy'){icon='ph-cloud-rain';color='text-blue-400';desc='æœ‰é›¨';} 
            const locEl = document.getElementById('location-name'); if(locEl) locEl.innerText=loc; 
            const tempEl = document.getElementById('weather-temp'); if(tempEl) tempEl.innerText=`${temp}Â°`; 
            const descEl = document.getElementById('weather-desc'); if(descEl) descEl.innerText=desc; 
            const iconEl = document.getElementById('weather-icon'); if(iconEl) iconEl.className=`ph-fill ${icon} text-4xl ${color}`; 
            const humEl = document.getElementById('weather-humidity'); if(humEl) humEl.innerText=`æ¿•åº¦ ${humidity}%`; 
            const windEl = document.getElementById('weather-wind'); if(windEl) windEl.innerText=`é¢¨é€Ÿ ${wind}km/h`; 
            const mTemp = document.getElementById('mobile-weather-temp'); if(mTemp) mTemp.innerText=loc==='æœªå®šä½'?'å®šä½':`${temp}Â°`; 
            const mIcon = document.getElementById('mobile-weather-icon'); if(mIcon) mIcon.className=`ph-fill ${loc==='æœªå®šä½'?'ph-navigation-arrow':icon} ${color}`; 
        }

        function updateModelUI(){ 
            const conf=MODEL_CONFIG[appState.currentModel]; 
            const statusName = document.getElementById('status-name'); if(statusName) statusName.innerText=conf.name; 
            const statusIcon = document.getElementById('status-icon'); if(statusIcon) statusIcon.className=`ph-fill ${conf.icon} text-lg ${conf.color}`; 
            document.querySelectorAll('.model-pill').forEach(b=>{ b.className = `model-pill px-3 py-1 rounded-lg text-[10px] font-bold ${b.dataset.model===appState.currentModel ? `${conf.bg} text-white` : 'bg-slate-800 text-slate-400'} transition-all whitespace-nowrap`; }); 
            const wrap = document.getElementById('input-wrapper'); if(wrap) wrap.className = `flex items-center bg-slate-950 rounded-xl px-2 py-2 border transition-colors border-slate-700 focus-within:border-${appState.currentModel==='gemini'?'blue':appState.currentModel==='cerebras'?'orange':appState.currentModel==='openrouter'?'purple':appState.currentModel==='gpt'?'emerald':appState.currentModel==='zeabur'?'pink':'slate'}-500`; 
            const badge=document.getElementById('web-search-badge'); const searchBtn=document.getElementById('search-toggle-btn'); const hint=document.getElementById('search-hint'); 
            if(searchBtn) {
                if(appState.isSearchEnabled){ searchBtn.classList.add('text-blue-400','bg-blue-900/30'); searchBtn.classList.remove('text-slate-500'); if(badge)badge.classList.remove('hidden'); if(hint)hint.classList.remove('hidden'); }
                else{ searchBtn.classList.remove('text-blue-400','bg-blue-900/30'); searchBtn.classList.add('text-slate-500'); if(badge)badge.classList.add('hidden'); if(hint)hint.classList.add('hidden'); }
            }
            if(appState.currentModel!=='gemini'&&appState.isSearchEnabled){setModel('gemini');} 
            const orBadge=document.getElementById('openrouter-badge');
            if(orBadge) { if(appState.currentModel === 'openrouter'){ orBadge.classList.remove('hidden'); orBadge.classList.add('flex'); const orName = document.getElementById('or-model-name'); if(orName) orName.innerText = getShortName(appState.openRouterModel); } else { orBadge.classList.add('hidden'); orBadge.classList.remove('flex'); } } 
        }

        // --- ACTIONS ---
        function addMessage(text, sender, model, sources=[]) { appState.messages.push({id:Date.now(), text, sender, model, sources, time:getTime()}); saveMessages(); renderMessages(); }
        function deleteMessage(id) { appState.messages = appState.messages.filter(m => m.id !== id); saveMessages(); renderMessages(); }
        function clearChatHistory() { if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å°è©±ç´€éŒ„å—ï¼Ÿ")) { appState.messages = []; saveMessages(); renderMessages(); } }
        function toggleTodo(id){ const t=appState.todos.find(x=>x.id===id); if(t){t.done=!t.done;saveData();renderTodos();} }
        function deleteTodo(id){ appState.todos=appState.todos.filter(x=>x.id!==id); saveData(); renderTodos(); }
        function deleteNote(id){ appState.notes=appState.notes.filter(x=>x.id!==id); saveData(); renderNotes(); }
        function addTodoManually(){ const t=prompt("ä»»å‹™"); if(t){appState.todos.push({id:Date.now(),text:t,done:false,time:'æ‰‹å‹•'});saveData();renderTodos();} }
        function addNoteManually(){ const t=prompt("æ¨™é¡Œ"),c=prompt("å…§å®¹"); if(t&&c){appState.notes.push({id:Date.now(),title:t,content:c,date:new Date().toLocaleDateString()});saveData();renderNotes();} }
        function switchTab(id){ ['dashboard','schedule','notes'].forEach(t=>document.getElementById(`view-${t}`).classList.add('hidden')); document.getElementById(`view-${id}`).classList.remove('hidden'); document.getElementById(`view-${id}`).classList.add('flex'); document.querySelectorAll('.nav-item').forEach(b=>{b.className='nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 transition-all';}); const active=document.getElementById(`nav-${id}`); if(active)active.className='nav-item flex items-center space-x-3 w-full p-4 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg transition-all'; }
        function openSettings(){document.getElementById('settings-modal').classList.remove('hidden');}
        function closeSettings(){document.getElementById('settings-modal').classList.add('hidden');}
        function saveKeys(){ appState.keys.gemini=document.getElementById('key-gemini').value.trim(); appState.keys.cerebras=document.getElementById('key-cerebras').value.trim(); appState.keys.openrouter=document.getElementById('key-openrouter').value.trim(); appState.keys.openai=document.getElementById('key-openai').value.trim(); appState.keys.grok=document.getElementById('key-grok').value.trim(); appState.openRouterModel=document.getElementById('model-openrouter-select').value; appState.docMonitorUrl=document.getElementById('key-doc-url').value.trim(); appState.zeaburUrl=document.getElementById('key-zeabur-url').value.trim(); appState.zeaburKey=document.getElementById('key-zeabur-key').value.trim(); localStorage.setItem('nova_key_gemini',appState.keys.gemini); localStorage.setItem('nova_key_cerebras',appState.keys.cerebras); localStorage.setItem('nova_key_openrouter',appState.keys.openrouter); localStorage.setItem('nova_key_openai',appState.keys.openai); localStorage.setItem('nova_key_grok',appState.keys.grok); localStorage.setItem('nova_or_model', appState.openRouterModel); localStorage.setItem('nova_doc_url', appState.docMonitorUrl); localStorage.setItem('nova_key_zeabur_url', appState.zeaburUrl); localStorage.setItem('nova_key_zeabur_key', appState.zeaburKey); appState.detectedGeminiModel=null; updateModelUI(); startDocMonitor(); closeSettings(); addMessage("è¨­å®šå·²å„²å­˜", 'system'); }
        function setModel(m){ appState.currentModel=m; updateModelUI(); }
        function toggleMobileMenu(){document.getElementById('mobile-menu').classList.toggle('hidden');}
        function updateSendButtonState(isLoading) { const btn=document.getElementById('send-btn'),icon=document.getElementById('send-icon'); if(isLoading){btn.classList.add('cursor-not-allowed','opacity-70');icon.classList.remove('ph-paper-plane-right');icon.classList.add('ph-spinner','animate-spin');}else{btn.classList.remove('cursor-not-allowed','opacity-70');icon.classList.remove('ph-spinner','animate-spin');icon.classList.add('ph-paper-plane-right');} }
        function toggleSearch() { appState.isSearchEnabled = !appState.isSearchEnabled; updateModelUI(); }
        function cycleManualLocation() { appState.manualLocIndex = (appState.manualLocIndex + 1) % appState.manualLocs.length; const loc = appState.manualLocs[appState.manualLocIndex]; fetchWeather(loc.lat, loc.lon, loc.name + " (æ‰‹å‹•)", false); }
        async function tryGetLocation(silent=false) { if(!silent) updateLocStatus("GPS..."); if (navigator.geolocation) { navigator.geolocation.getCurrentPosition((p) => fetchWeather(p.coords.latitude, p.coords.longitude, "GPS", silent), (e) => getIPLocation(silent), { timeout: 5000 }); } else getIPLocation(silent); }
        async function getIPLocation(silent) { if(!silent) updateLocStatus("IP..."); try { const res = await fetch('https://ipapi.co/json/'); if(!res.ok)throw new Error(); const data=await res.json(); fetchWeather(data.latitude, data.longitude, `${data.city}(IP)`, silent); } catch(e){ try { const res2 = await fetch('https://ipwho.is/'); const data2 = await res2.json(); if(!data2.success)throw new Error(); fetchWeather(data2.latitude, data2.longitude, `${data2.city}(IP)`, silent); } catch(e2) { updateLocStatus("å¤±æ•—"); if(!silent) addMessage("âš ï¸ å®šä½å¤±æ•—ï¼Œå·²åˆ‡æ›è‡³é è¨­åŸå¸‚", "system"); const def = appState.manualLocs[0]; fetchWeather(def.lat, def.lon, def.name + " (é è¨­)", true); } } }
        async function fetchWeather(lat, lon, locName, silent) { try { const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`; const res = await fetch(url); const data = await res.json(); if(data.current) { const c = data.current; appState.weather = { temp: Math.round(c.temperature_2m), humidity: c.relative_humidity_2m, wind: c.wind_speed_10m, condition: wmoToCondition(c.weather_code), loc: locName }; renderWeather(); updateLocStatus("å·²æ›´æ–°"); if(!silent) addMessage(`âœ… å¤©æ°£å·²æ›´æ–°: ${c.temperature_2m}Â°C`, "system"); } } catch(e) { updateLocStatus("éŒ¯èª¤"); } }
        function updateLocStatus(msg) { 
            const el = document.getElementById('location-status'); 
            if(el) el.innerText = msg; 
            if(msg==="å·²æ›´æ–°"||msg.includes("é è¨­")||msg.includes("æ‰‹å‹•")) { 
                const {loc, temp} = appState.weather; 
                const locName = document.getElementById('location-name'); if(locName) locName.innerText = loc; 
                const mTemp = document.getElementById('mobile-weather-temp'); if(mTemp) mTemp.innerText = `${temp}Â°`; 
            } 
        }
        function wmoToCondition(c) { if(c===0)return 'sunny'; if(c<=48)return 'cloudy'; if(c<=82)return 'rainy'; if(c<=77)return 'snow'; return 'storm'; }

        // --- WEB SCRAPER ---
        async function fetchUrlViaGas(url) {
            if (!appState.docMonitorUrl) return null;
            try {
                const res = await fetch(appState.docMonitorUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ type: 'scrape_and_log', url: url })
                });
                const text = await res.text();
                if (text && !text.startsWith("Error")) return text;
                return null;
            } catch (e) {
                console.error("GAS Scrape Error:", e);
                return null;
            }
        }

        async function extractContentFromUrl(url) {
            if (appState.docMonitorUrl) {
                const gasContent = await fetchUrlViaGas(url);
                if (gasContent) return gasContent;
            }
            try {
                if (url.includes('youtube.com') || url.includes('youtu.be') || url.includes('facebook.com') || url.includes('twitter.com') || url.includes('x.com')) return null;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const res = await fetch(proxyUrl);
                const data = await res.json();
                if (!data.contents) return null;
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, 'text/html');
                const scripts = doc.querySelectorAll('script, style, nav, footer, header, aside, iframe, noscript');
                scripts.forEach(node => node.remove());
                let text = doc.body.innerText || "";
                text = text.replace(/\s+/g, ' ').trim();
                return text.substring(0, 15000); 
            } catch (e) { return null; }
        }

        async function getYouTubeMetadata(url) {
            try {
                const oembedUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(oembedUrl)}`;
                const res = await fetch(proxyUrl);
                const data = await res.json();
                if (!data.contents) return null;
                return JSON.parse(data.contents);
            } catch (e) { return null; }
        }

        // --- HANDLERS ---
        function handleEnter(e) { if(e.key==='Enter') handleSendMessage(); }
        
        async function handleSendMessage() {
            if(appState.isThinking) return;
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if(!text) return;

            appState.isThinking = true;
            updateSendButtonState(true);
            addMessage(text, 'user');
            input.value = '';
            renderThinkingState(true);

            try {
                let systemPromptAddon = "";
                let injectedContext = "";
                let modelToUse = appState.currentModel;
                let enableSearchTool = false; // Default: disable tool to prevent conflict
                
                // If global search is ON, default to true unless overridden
                if (appState.isSearchEnabled) enableSearchTool = true;

                const searchMatch = text.match(/^(?:æœå°‹|æŸ¥è©¢|æœç´¢|æŸ¥|æ‰¾|search|query)[:ï¼š\s]\s*(.+)/i);
                if (searchMatch && appState.keys.gemini) {
                    modelToUse = 'gemini';
                    enableSearchTool = true; // Force ON for explicit search
                    systemPromptAddon += `(ç³»çµ±æŒ‡ä»¤: ä½¿ç”¨è€…æ­£åœ¨è¦æ±‚æœå°‹ã€‚è«‹å‹™å¿…ä½¿ç”¨ Google Search å·¥å…·æŸ¥æ‰¾ã€Œ${searchMatch[1]}ã€çš„æœ€æ–°è³‡è¨Šï¼Œä¸¦è©³ç´°å›ç­”ã€‚è‹¥æ‚¨ç„¡æ³•ä½¿ç”¨å·¥å…·ï¼Œè«‹èª å¯¦å‘ŠçŸ¥ã€‚)`;
                }

                const urlMatch = text.match(/https?:\/\/[^\s]+/);
                if (urlMatch) {
                    const url = urlMatch[0];
                    if (!url.includes('youtube.com') && !url.includes('youtu.be') && !url.includes('twitter.com') && !url.includes('facebook.com')) {
                        addMessage(`ğŸ” æ­£åœ¨é€é Google Doc ä»£ç†æŠ“å–ç¶²é ...`, 'system');
                        const content = await fetchUrlViaGas(url); // Use GAS 5.0 Scraper
                        if (content) {
                            injectedContext = `\n\n[ç³»çµ±: å·²é€é Google Doc æˆåŠŸæŠ“å–ç¶²é å…§å®¹ (${url})ï¼Œè«‹æ ¹æ“šä»¥ä¸‹å…§å®¹å›ç­”]:\n${content}\n\n`;
                            // IMPORTANT: Disable search tool if context is provided to prevent "No Content" error
                            enableSearchTool = false; 
                        } else {
                            systemPromptAddon += `(ç³»çµ±: å˜—è©¦æŠ“å–ç¶²é å¤±æ•—ï¼Œè«‹å˜—è©¦ä½¿ç”¨æ‚¨çš„ Search å·¥å…·æœå°‹è©²ç¶²å€å…§å®¹)`;
                            if (appState.keys.gemini) { modelToUse = 'gemini'; enableSearchTool = true; }
                        }
                    } else if (url.includes('youtube') || url.includes('youtu.be')) {
                         if (appState.keys.gemini) {
                            modelToUse = 'gemini';
                            enableSearchTool = true; 
                            systemPromptAddon += `(ç³»çµ±: é€™æ˜¯ä¸€å€‹ YouTube é€£çµã€‚è«‹ä½¿ç”¨ Search å·¥å…·æœå°‹è©²å½±ç‰‡çš„æ¨™é¡Œã€æ‘˜è¦æˆ–è©•è«–å…§å®¹ä¾†å›ç­”ã€‚)`;
                         }
                    }
                }

                const prompt = `${text}\n${systemPromptAddon}\n${injectedContext}`;
                const res = await fetchAIResponse(prompt, modelToUse, { enableSearch: enableSearchTool });
                
                if(typeof res === 'string') addMessage(res, 'ai', modelToUse);
                else addMessage(res.text, 'ai', modelToUse, res.sources);

            } catch (error) {
                console.error("Handler Error:", error);
                addMessage(`[ç³»çµ±éŒ¯èª¤] ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'system');
            } finally {
                appState.isThinking = false;
                updateSendButtonState(false);
                renderThinkingState(false);
            }
        }

        async function fetchAIResponse(userText, model, options = {}) {
            const fetchWithTimeout = async (url, options, timeout = 30000) => {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                try { const response = await fetch(url, { ...options, signal: controller.signal }); clearTimeout(id); return response; } 
                catch (error) { clearTimeout(id); throw new Error(error.name === 'AbortError' ? 'é€£ç·šé€¾æ™‚ (30s)' : error.message); }
            };

            try {
                if(model === 'zeabur') {
                    if(!appState.zeaburUrl) throw new Error("è«‹è¨­å®š Zeabur API URL");
                    const res = await fetchWithTimeout(appState.zeaburUrl, { method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${appState.zeaburKey}`}, body: JSON.stringify({ model: 'user-model', messages: [{ role: 'user', content: userText }] }) });
                    const data = await res.json(); return data.choices?.[0]?.message?.content || "ç„¡å›æ‡‰";
                }
                const key = appState.keys[model];
                if(!key) throw new Error(`è«‹è¨­å®š ${MODEL_CONFIG[model].name} API Key`);

                if(model === 'gemini') {
                    if(!appState.detectedGeminiModel) appState.detectedGeminiModel = await detectAvailableGeminiModel(key);
                    let modelName = appState.detectedGeminiModel;
                    if (options.enableSearch && !modelName.includes('pro')) {
                         const pro = appState.detectedGeminiModel.replace('flash', 'pro');
                         modelName = pro; 
                    }
                    modelName = modelName.replace('models/', '');

                    const payload = { contents:[{parts:[{text:userText}]}] };
                    // Only add tools if explicitly enabled for this turn
                    if (options.enableSearch) {
                        payload.tools = [{google_search:{}}];
                    }

                    const res = await fetchWithTimeout(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                    const data = await res.json();
                    
                    if(data.error) {
                        if (payload.tools) {
                            delete payload.tools;
                            const retry = await fetchWithTimeout(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                            const d = await retry.json();
                            return (d.candidates?.[0]?.content?.parts?.[0]?.text) || "ç„¡å…§å®¹ (æœå°‹å¤±æ•—å¾Œé‡è©¦)";
                        }
                        throw new Error(data.error.message);
                    }
                    
                    if (data.promptFeedback && data.promptFeedback.blockReason) {
                        return `âš ï¸ å…§å®¹è¢«å®‰å…¨æ©Ÿåˆ¶é˜»æ“‹ (${data.promptFeedback.blockReason})`;
                    }
                    
                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                        return "âš ï¸ ç„¡æ³•ç”Ÿæˆå…§å®¹ (å¯èƒ½åŸå› : å®‰å…¨éæ¿¾ã€ç„¡æœå°‹çµæœæˆ– API æš«æ™‚ç„¡å›æ‡‰)";
                    }
                    
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "ç„¡å…§å®¹";
                    let sources = []; 
                    data.candidates?.[0]?.groundingMetadata?.groundingAttributions?.forEach(a => { if(a.web?.uri) sources.push({title:a.web.title, uri:a.web.uri}); });
                    return {text, sources};
                } else if (model === 'openrouter') {
                    const res = await fetchWithTimeout('https://openrouter.ai/api/v1/chat/completions', { method: 'POST', headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json', 'HTTP-Referer': 'https://github.com/nova-ai', 'X-Title': 'Nova AI' }, body: JSON.stringify({ model: appState.openRouterModel, messages: [{ role: 'user', content: userText }] }) });
                    const data = await res.json();
                    return data.choices?.[0]?.message?.content || "ç„¡å›æ‡‰";
                } else if(model === 'cerebras') {
                    const res = await fetchWithTimeout('https://api.cerebras.ai/v1/chat/completions', { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${key}`}, body: JSON.stringify({model:"llama-3.3-70b", messages:[{role:"user", content:userText}], stream:false}) });
                    const data = await res.json(); if(data.error) throw new Error(data.error.message); return data.choices?.[0]?.message?.content || "ç„¡å›æ‡‰";
                } else {
                    const ep = model==='gpt'?'https://api.openai.com/v1/chat/completions':'https://api.x.ai/v1/chat/completions';
                    const mName = model==='gpt'?'gpt-4o-mini':'grok-beta';
                    const res = await fetchWithTimeout(ep, { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${key}`}, body: JSON.stringify({model:mName, messages:[{role:"user", content:userText}]}) });
                    const data = await res.json(); if(data.error) throw new Error(data.error.message); return data.choices[0].message.content;
                }
            } catch(e) { throw e; }
        }

        async function detectAvailableGeminiModel(apiKey) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const data = await res.json();
                const models = data.models.filter(m => m.supportedGenerationMethods?.includes("generateContent"));
                return (models.find(m=>m.name.includes("gemini-1.5-pro")) || models.find(m=>m.name.includes("gemini-1.5-flash")) || models[0]).name;
            } catch(e) { return 'gemini-1.5-pro'; }
        }

        function testDocConnection() {
            const url = document.getElementById('key-doc-url').value.trim();
            if(!url) return alert("è«‹è¼¸å…¥ URL");
            document.getElementById('doc-monitor-status').innerText = "æ¸¬è©¦ä¸­...";
            fetch(url).then(r=>r.text()).then(t=>{
                alert("é€£ç·šæˆåŠŸï¼");
                document.getElementById('doc-monitor-status').innerText = "æ¸¬è©¦æˆåŠŸ";
            }).catch(e=>{
                alert("é€£ç·šå¤±æ•—ï¼š" + e.message);
                document.getElementById('doc-monitor-status').innerText = "æ¸¬è©¦å¤±æ•—";
            });
        }

        function startDocMonitor() {
            if(appState.docMonitorInterval) clearInterval(appState.docMonitorInterval);
            if(!appState.docMonitorUrl) return;
            document.getElementById('doc-monitor-badge').classList.remove('hidden');
            document.getElementById('doc-monitor-badge').classList.add('flex');
        }

        // --- INIT ---
        window.onload = () => {
            if(appState.messages.length === 0) {
                appState.messages.push({ id: 1, text: 'Nova 12.15 å°±ç·’ï¼\nç©©å®šç‰ˆæ›´æ–°ï¼š\n1. ä¿®å¾©ç¶²é å…§å®¹è®€å–æ™‚çš„ã€Œç„¡å…§å®¹ã€éŒ¯èª¤ã€‚\n2. ç•¶æˆåŠŸæŠ“å–ç¶²é æ™‚ï¼Œè‡ªå‹•é—œé–‰æœå°‹å·¥å…·ä»¥é¿å…è¡çªã€‚\n3. ä¿®å¾©æ‰€æœ‰èªæ³•éŒ¯èª¤ï¼Œè«‹å®‰å¿ƒä½¿ç”¨ã€‚', sender: 'ai', model: 'gemini', time: getTime() });
            }
            renderAll();
            
            // Safe initialization of values
            const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
            
            safeSet('key-gemini', appState.keys.gemini);
            safeSet('key-cerebras', appState.keys.cerebras);
            safeSet('key-openrouter', appState.keys.openrouter);
            safeSet('key-openai', appState.keys.openai);
            safeSet('key-grok', appState.keys.grok);
            safeSet('key-doc-url', appState.docMonitorUrl);
            safeSet('key-zeabur-url', appState.zeaburUrl);
            safeSet('key-zeabur-key', appState.zeaburKey);
            safeSet('model-openrouter-select', appState.openRouterModel);
            
            tryGetLocation(true);
            updateModelUI();
        };
    </script>
</body>
</html>
