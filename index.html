<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nova 12.30.2 - Voice & Search Logic Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { slate: { 925: '#0f172a' } },
                    animation: { 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'spin-slow': 'spin 2s linear infinite' }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        .dot-flashing {
            position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #9880ff; color: #9880ff;
            animation: dot-flashing 1s infinite linear alternate; animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: ""; display: inline-block; position: absolute; top: 0; width: 6px; height: 6px; border-radius: 5px; background-color: #9880ff; color: #9880ff; animation: dot-flashing 1s infinite alternate;
        }
        .dot-flashing::before { left: -10px; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { background-color: #9880ff; } 50%, 100% { background-color: rgba(152, 128, 255, 0.2); } }
        .msg-content a, #doc-content-area a { color: #60a5fa; text-decoration: underline; word-break: break-all; cursor: pointer; }
        .msg-content img, #doc-content-area img { max-width: 100%; height: auto; border-radius: 8px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.1); }
        .msg-content p, #doc-content-area div { margin-bottom: 0.5em; line-height: 1.6; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .msg-group:hover .msg-actions { opacity: 1; }
        .msg-actions { opacity: 0; transition: opacity 0.2s; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans overflow-hidden selection:bg-blue-500/30">

    <div class="flex h-[100dvh] w-full">
        <aside class="hidden md:flex flex-col w-64 bg-slate-900 border-r border-slate-800 p-6 flex-shrink-0">
            <div class="flex items-center space-x-3 mb-10 px-2">
                <div class="w-10 h-10 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i class="ph-bold ph-infinity text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white tracking-wide">NOVA</h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider">Voice Fix 12.30.2</p>
                </div>
            </div>
            <nav class="flex-1 space-y-2">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg transition-all"><i class="ph ph-chats-circle text-xl"></i><span class="font-medium">åŠ©ç†å°è©±</span></button>
                <button onclick="switchTab('schedule')" id="nav-schedule" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all"><i class="ph ph-calendar-check text-xl"></i><span class="font-medium">è¡Œç¨‹ç®¡ç†</span></button>
                <button onclick="switchTab('notes')" id="nav-notes" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all"><i class="ph ph-notebook text-xl"></i><span class="font-medium">ç­†è¨˜/æ–‡ä»¶</span></button>
            </nav>
            <div class="mt-auto space-y-3">
                <button onclick="openSettings()" class="flex items-center space-x-2 text-xs text-slate-500 hover:text-slate-300 w-full px-2"><i class="ph ph-gear"></i><span>è¨­å®š & API</span></button>
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                    <div class="flex items-center space-x-2"><i id="status-icon" class="ph-fill ph-globe text-blue-400 text-lg"></i><span id="status-name" class="font-bold text-sm">Gemini</span></div>
                    <p id="model-version-display" class="text-[10px] text-slate-500 mt-1">Ready</p>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-slate-950 overflow-hidden min-h-0">
            <div class="md:hidden flex items-center justify-between p-3 bg-slate-900 border-b border-slate-800 z-30 shrink-0">
                <div class="flex items-center space-x-2"><i class="ph-bold ph-infinity text-blue-500 text-xl"></i><span class="font-bold text-white">Nova</span></div>
                <div class="flex items-center space-x-2 bg-slate-800/50 px-2 py-1 rounded-lg border border-slate-700/50 cursor-pointer active:scale-95 transition-transform" onclick="cycleManualLocation()">
                    <i id="mobile-weather-icon" class="ph-fill ph-navigation-arrow text-blue-400"></i><span id="mobile-weather-temp" class="text-xs font-bold text-white">æ›´æ–°</span>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="openSettings()"><i class="ph ph-gear text-slate-400 text-xl"></i></button>
                    <button onclick="toggleMobileMenu()"><i class="ph ph-list text-white text-2xl"></i></button>
                </div>
            </div>

            <div id="mobile-menu" class="hidden md:hidden fixed inset-0 z-40 bg-slate-950/95 pt-20 px-6 backdrop-blur-md">
                <nav class="space-y-4">
                    <button onclick="switchTab('dashboard'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl bg-slate-800 text-white"><i class="ph ph-chats-circle text-xl"></i><span>åŠ©ç†å°è©±</span></button>
                    <button onclick="switchTab('schedule'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800"><i class="ph ph-calendar-check text-xl"></i><span>è¡Œç¨‹ç®¡ç†</span></button>
                    <button onclick="switchTab('notes'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800"><i class="ph ph-notebook text-xl"></i><span>ç­†è¨˜/æ–‡ä»¶</span></button>
                </nav>
            </div>

            <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-slate-950/90 backdrop-blur-sm flex items-center justify-center p-4">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-md shadow-2xl">
                    <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white">è¨­å®š</h3><button onclick="closeSettings()"><i class="ph ph-x text-2xl text-slate-400"></i></button></div>
                    <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                        <div class="bg-gradient-to-r from-blue-900/30 to-indigo-900/30 p-4 rounded-xl border border-blue-500/50 shadow-inner">
                            <label class="block text-xs text-blue-300 mb-2 font-bold flex items-center gap-2"><i class="ph-fill ph-robot"></i> ç³»çµ±ä»£ç† Google Doc (æœå°‹/çˆ¬èŸ²)</label>
                            <input type="text" id="key-doc-url" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-xs focus:border-blue-500 outline-none mb-2" placeholder="Apps Script URL (for Agent)">
                            <label class="block text-xs text-emerald-300 mb-2 mt-4 font-bold flex items-center gap-2"><i class="ph-fill ph-notebook"></i> éš¨æ‰‹è¨˜äº‹æœ¬ Google Doc (å¯«å…¥/é–±è®€)</label>
                            <input type="text" id="key-note-doc-url" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-xs focus:border-emerald-500 outline-none mb-2" placeholder="Apps Script URL (for Notes)">
                            <div class="flex items-center justify-between">
                                <span id="doc-monitor-status" class="text-[10px] text-slate-500">æœªè¨­å®š</span>
                                <button onclick="testDocConnection()" class="text-[10px] bg-blue-600 px-3 py-1 rounded text-white hover:bg-blue-500">æ¸¬è©¦é€£ç·š</button>
                            </div>
                        </div>
                        <div class="space-y-3 pt-2">
                            <div><label class="block text-xs text-blue-400 mb-1">Gemini API Key</label><input type="password" id="key-gemini" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-purple-400 mb-1">OpenRouter Key</label><input type="password" id="key-openrouter" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-purple-500 outline-none"></div>
                            <div><label class="block text-xs text-orange-400 mb-1">Cerebras API Key</label><input type="password" id="key-cerebras" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-orange-500 outline-none"></div>
                            <div><label class="block text-xs text-emerald-400 mb-1">OpenAI API Key</label><input type="password" id="key-openai" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-emerald-500 outline-none"></div>
                            <select id="model-openrouter-select" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs text-white outline-none focus:border-purple-500 mt-1"><option value="deepseek/deepseek-r1:free">DeepSeek R1</option><option value="meta-llama/llama-3.3-70b-instruct:free">Llama 3.3</option><option value="google/gemini-2.0-flash-lite-preview-02-05:free">Gemini 2.0 Flash</option><option value="anthropic/claude-3.5-sonnet">Claude 3.5</option></select>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3"><button onclick="closeSettings()" class="px-4 py-2 text-slate-400 text-sm">å–æ¶ˆ</button><button onclick="saveKeys()" class="px-6 py-2 bg-blue-600 text-white rounded-lg">å„²å­˜</button></div>
                </div>
            </div>

            <div id="view-dashboard" class="flex flex-col lg:flex-row h-full w-full relative min-h-0">
                <div class="flex-1 flex flex-col h-full min-w-0 relative">
                    <div class="p-3 border-b border-slate-800 bg-slate-900/50 backdrop-blur-sm flex justify-between items-center shrink-0 overflow-x-auto no-scrollbar">
                         <div class="flex items-center space-x-2 mr-4">
                            <span id="web-search-badge" class="hidden md:flex items-center space-x-1 text-[10px] bg-blue-900/30 text-blue-400 border border-blue-500/30 px-2 py-0.5 rounded-full"><i class="ph-bold ph-globe"></i><span>é€£ç¶²æœå°‹</span></span>
                            <button onclick="clearChatHistory()" class="text-[10px] text-slate-500 hover:text-red-400 flex items-center space-x-1 border border-slate-700 px-2 py-0.5 rounded-lg transition-colors"><i class="ph-bold ph-trash"></i><span>æ¸…ç©ºå°è©±</span></button>
                         </div>
                         <div class="flex space-x-1">
                            <button onclick="setModel('gemini')" class="model-pill px-3 py-1 rounded-lg text-[10px] font-bold bg-blue-600 text-white transition-all whitespace-nowrap" data-model="gemini">Gemini</button>
                            <button onclick="setModel('openrouter')" class="model-pill px-3 py-1 rounded-lg text-[10px] font-bold bg-slate-800 text-slate-400 transition-all whitespace-nowrap" data-model="openrouter">OpenRouter</button>
                            <button onclick="setModel('zeabur')" class="model-pill px-3 py-1 rounded-lg text-[10px] font-bold bg-slate-800 text-slate-400 transition-all whitespace-nowrap" data-model="zeabur">Zeabur</button>
                            <button onclick="setModel('cerebras')" class="model-pill px-3 py-1 rounded-lg text-[10px] font-bold bg-slate-800 text-slate-400 transition-all whitespace-nowrap" data-model="cerebras">Cerebras</button>
                            <button onclick="setModel('gpt')" class="model-pill px-3 py-1 rounded-lg text-[10px] font-bold bg-slate-800 text-slate-400 transition-all whitespace-nowrap" data-model="gpt">GPT</button>
                         </div>
                    </div>
                    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 scrollbar-thin scrollbar-thumb-slate-700"></div>
                    <div class="p-4 bg-slate-900 border-t border-slate-800 shrink-0 z-20 pb-[calc(1rem+env(safe-area-inset-bottom))]">
                        <div id="input-wrapper" class="flex items-center bg-slate-950 rounded-xl px-2 py-2 border border-slate-700 focus-within:border-blue-500 transition-colors">
                            <button id="search-toggle-btn" onclick="toggleSearch()" class="p-3 rounded-lg text-slate-500 hover:text-blue-400 hover:bg-slate-800 transition-all flex-shrink-0 mr-1" title="åˆ‡æ›æœå°‹ (Gemini Only)"><i id="search-icon" class="ph-bold ph-globe text-xl"></i></button>
                            <button id="voice-btn" onclick="toggleVoice()" class="p-3 mr-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-all active:scale-95 flex-shrink-0"><i id="voice-icon" class="ph-bold ph-microphone text-xl"></i></button>
                            <input type="text" id="user-input" placeholder="è²¼ä¸Šç¶²å€è‡ªå‹•åˆ†æï¼Œæˆ–è¼¸å…¥ã€Œæœå°‹ï¼šé—œéµå­—ã€..." class="flex-1 bg-transparent border-none focus:ring-0 text-white outline-none h-full" onkeydown="handleEnter(event)">
                            <button onclick="handleSendMessage()" id="send-btn" class="ml-2 p-3 rounded-lg text-white bg-blue-600 hover:opacity-90 flex-shrink-0 transition-all"><i id="send-icon" class="ph-bold ph-paper-plane-right"></i></button>
                        </div>
                        <div id="search-hint" class="text-[10px] text-blue-400 mt-2 text-center hidden">ğŸŒ å·²é–‹å•Ÿé€£ç¶²æœå°‹ (Gemini)</div>
                    </div>
                </div>
                
                <div class="hidden lg:flex w-80 bg-slate-900 flex-col p-6 space-y-6 border-l border-slate-800 overflow-y-auto shrink-0">
                    <div class="bg-gradient-to-br from-indigo-900 to-slate-800 rounded-3xl p-6 text-white shadow-lg border border-slate-700 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/20 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start">
                                <div><h3 class="text-slate-300 text-xs font-bold uppercase mb-1">ç›®å‰å¤©æ°£</h3><div class="flex items-center space-x-2 cursor-pointer hover:opacity-80 transition-opacity" onclick="cycleManualLocation()"><i class="ph-fill ph-map-pin text-blue-400"></i><span id="location-name" class="text-lg font-bold text-white border-b border-dashed border-slate-500">æœªå®šä½</span></div></div><i id="weather-icon" class="ph-fill ph-cloud-sun text-4xl text-yellow-400"></i>
                            </div>
                            <div class="mt-4 flex items-end space-x-2"><span id="weather-temp" class="text-5xl font-bold">--Â°</span><span id="weather-desc" class="text-slate-300 text-sm mb-2">--</span></div>
                        </div>
                    </div>
                    <div class="bg-slate-950 rounded-2xl p-5 border border-slate-800">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-200 text-sm flex items-center gap-2"><i class="ph-fill ph-calendar-check text-blue-500"></i>è¿‘æœŸä»»å‹™</h3><button onclick="switchTab('schedule')" class="text-xs text-blue-400">ç®¡ç†</button></div>
                        <div id="mini-todo-list" class="space-y-2"></div>
                    </div>
                    <div class="bg-slate-950 rounded-2xl p-5 border border-slate-800">
                         <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-200 text-sm flex items-center gap-2"><i class="ph-fill ph-notebook text-emerald-500"></i>æœ€æ–°ç­†è¨˜</h3><button onclick="switchTab('notes')" class="text-xs text-blue-400">æŸ¥çœ‹</button></div>
                        <div id="mini-note-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div id="view-schedule" class="hidden flex-col h-full w-full p-6 overflow-y-auto"><div class="max-w-3xl mx-auto w-full"><header class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">è¡Œç¨‹ç®¡ç†</h2><button onclick="addTodoManually()" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2"><i class="ph-bold ph-plus"></i><span>æ–°å¢</span></button></header><div id="full-todo-list" class="space-y-3"></div></div></div>
            
            <div id="view-notes" class="hidden flex-col h-full w-full p-6 overflow-y-auto">
                <div class="max-w-5xl mx-auto w-full">
                    <div class="bg-gradient-to-r from-blue-900/40 to-slate-900 border border-blue-500/30 rounded-2xl p-6 mb-8 relative overflow-hidden shadow-lg">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-blue-500/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="ph-fill ph-notebook text-emerald-400"></i> éš¨æ‰‹è¨˜äº‹æœ¬ (Notebook)</h3>
                                <button onclick="openNoteDocViewer()" class="text-xs bg-slate-800 hover:bg-slate-700 text-white px-3 py-1.5 rounded-lg border border-slate-600 flex items-center gap-2 transition-colors"><i class="ph-bold ph-book-open"></i> ğŸ“– é–±è®€ç­†è¨˜æœ¬</button>
                            </div>
                            <div class="flex space-x-2 mb-3">
                                <button onclick="setWriteMode('text')" id="btn-mode-text" class="text-xs px-3 py-1 rounded-full bg-blue-600 text-white font-bold transition-all">ç´”æ–‡å­— / è²¼ä¸Šåœ–ç‰‡ (Ctrl+V)</button>
                                <button onclick="setWriteMode('image')" id="btn-mode-image" class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-400 font-bold hover:text-white transition-all">åœ–ç‰‡ç¶²å€</button>
                                <button onclick="setWriteMode('link')" id="btn-mode-link" class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-400 font-bold hover:text-white transition-all">è¶…é€£çµ</button>
                            </div>
                            <div class="flex flex-col gap-3">
                                <div class="relative">
                                    <textarea id="doc-input-main" rows="5" placeholder="è¼¸å…¥æ–‡å­—å…§å®¹..." class="w-full bg-slate-950/80 border border-slate-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none resize-none"></textarea>
                                    <button onclick="clearNoteInput()" class="absolute right-3 bottom-3 text-slate-500 hover:text-red-400 p-1 bg-slate-900/50 rounded-full transition-colors"><i class="ph-bold ph-trash"></i></button>
                                </div>
                                <input type="text" id="doc-input-sub" placeholder="è¼¸å…¥é€£çµç¶²å€" class="hidden w-full bg-slate-950/80 border border-slate-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none">
                                <div class="flex justify-end">
                                    <button onclick="handleDocWriteBtn()" id="note-send-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2"><i class="ph-bold ph-paper-plane-right"></i> ç™¼é€å¯«å…¥</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <header class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">æœ¬åœ°ç­†è¨˜ä¸­å¿ƒ</h2><button onclick="addNoteManually()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2"><i class="ph-bold ph-plus"></i><span>æ–°å¢</span></button></header>
                    <div id="full-note-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let recognition = null;
        let noteRecognition = null;
        let voiceTimer = null;
        let initialInput = "";

        const appState = {
            currentModel: 'gemini', detectedGeminiModel: null,
            openRouterModel: localStorage.getItem('nova_or_model') || 'deepseek/deepseek-r1:free',
            docMonitorUrl: localStorage.getItem('nova_doc_url') || '',
            noteDocUrl: localStorage.getItem('nova_note_doc_url') || '', 
            keys: { 
                gemini: localStorage.getItem('nova_key_gemini')||'', 
                cerebras: localStorage.getItem('nova_key_cerebras')||'', 
                openrouter: localStorage.getItem('nova_key_openrouter')||'',
                openai: localStorage.getItem('nova_key_openai')||''
            },
            messages: JSON.parse(localStorage.getItem('nova_messages') || '[]'),
            todos: JSON.parse(localStorage.getItem('nova_todos') || '[]'),
            notes: JSON.parse(localStorage.getItem('nova_notes') || '[]'),
            weather: { temp: '--', condition: 'cloudy', loc: 'æœªå®šä½' },
            isThinking: false, isListening: false, isSearchEnabled: false,
            manualLocIndex: 0,
            manualLocs: [{name: "å°åŒ—", lat: 25.0330, lon: 121.5654}, {name: "å°ä¸­", lat: 24.1477, lon: 120.6736}, {name: "é«˜é›„", lat: 22.6273, lon: 120.3014}]
        };

        const MODEL_CONFIG = {
            gemini: { name: 'Gemini', color: 'text-blue-400', bg: 'bg-blue-600', icon: 'ph-globe' },
            openrouter: { name: 'OpenRouter', color: 'text-purple-400', bg: 'bg-purple-600', icon: 'ph-infinity' },
            cerebras: { name: 'Cerebras', color: 'text-orange-400', bg: 'bg-orange-600', icon: 'ph-rocket-launch' },
            gpt: { name: 'ChatGPT', color: 'text-emerald-400', bg: 'bg-emerald-600', icon: 'ph-cpu' },
            zeabur: { name: 'Zeabur', color: 'text-pink-400', bg: 'bg-pink-600', icon: 'ph-plant' }
        };

        // --- UTILS ---
        function saveMessages() { localStorage.setItem('nova_messages', JSON.stringify(appState.messages)); }
        function saveData() { localStorage.setItem('nova_todos', JSON.stringify(appState.todos)); localStorage.setItem('nova_notes', JSON.stringify(appState.notes)); }
        function getTime() { return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
        function escapeHtml(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}
        
        function formatMessage(text, isHtml = false) { 
            if (!text) return ''; 
            if (isHtml) return text;
            let safe = escapeHtml(text);
            safe = safe.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-bold">$1</strong>'); 
            safe = safe.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" class="text-blue-400 underline break-all">$1</a>'); 
            return safe.replace(/\n/g, '<br>'); 
        }

        // --- RENDERERS ---
        function renderMessages() { 
            const container = document.getElementById('chat-container');
            if(!container) return;
            container.innerHTML = appState.messages.map(msg => { 
                const isUser = msg.sender === 'user'; 
                const modelInfo = isUser ? null : MODEL_CONFIG[msg.model]; 
                let sourcesHTML = ''; 
                if (msg.sources?.length) sourcesHTML = `<div class="mt-3 pt-3 border-t border-slate-700/50"><p class="text-[10px] text-slate-400 mb-1 font-bold">ä¾†æºï¼š</p><div class="flex flex-wrap gap-2">${msg.sources.map((s,i)=>`<a href="${s.uri}" target="_blank" class="text-[10px] bg-slate-950/50 text-blue-400 px-2 py-1 rounded border border-slate-700/50 block truncate max-w-[150px]">${i+1}. ${s.title}</a>`).join('')}</div></div>`; 
                return `<div class="group flex ${isUser ? 'justify-end' : 'justify-start items-start space-x-3'} fade-in relative mb-4">
                    ${!isUser ? `<div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 mt-1 ${modelInfo?.bg||'bg-slate-700'}"><i class="ph-fill ${modelInfo?.icon||'ph-robot'} text-white text-sm"></i></div>` : ''}
                    <div class="msg-group relative max-w-[90%] md:max-w-[80%] rounded-2xl p-4 shadow-sm ${isUser ? 'bg-slate-800 text-white rounded-br-none' : 'bg-slate-900 border border-slate-800 text-slate-200 rounded-tl-none'}">
                        ${!isUser ? `<span class="text-[10px] font-bold uppercase mb-1 block ${modelInfo?.color||'text-slate-400'} opacity-80">${modelInfo?.name||'System'}</span>` : ''}
                        <div class="msg-content text-sm leading-relaxed">${formatMessage(msg.text, msg.isHtml)}</div>
                        ${sourcesHTML}
                        <p class="text-[10px] mt-2 text-right text-slate-500 opacity-60">${msg.time}</p>
                    </div>
                </div>`; 
            }).join(''); 
            container.scrollTop = container.scrollHeight; 
        }

        function renderThinkingState(show) { 
            const el = document.getElementById('thinking-indicator'); 
            const container = document.getElementById('chat-container');
            if(show && !el && container) container.insertAdjacentHTML('beforeend', `<div id="thinking-indicator" class="flex justify-start items-center space-x-3 fade-in"><div class="w-8 h-8 rounded-full flex items-center justify-center ${MODEL_CONFIG[appState.currentModel].bg}"><i class="ph-fill ${MODEL_CONFIG[appState.currentModel].icon} text-white text-sm"></i></div><div class="bg-slate-900 border border-slate-800 p-4 rounded-2xl rounded-tl-none"><div class="dot-flashing ml-2"></div></div></div>`); 
            else if(!show && el) el.remove(); 
        }

        // --- CORE AI LOGIC (FIXED) ---
        async function fetchAIResponse(userText, model, options = {}) {
            const fetchWithTimeout = async (url, opts, timeout = 30000) => {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                try {
                    const response = await fetch(url, { ...opts, signal: controller.signal });
                    clearTimeout(id);
                    return response;
                } catch (e) {
                    clearTimeout(id);
                    throw new Error(e.name === 'AbortError' ? 'é€£ç·šé€¾æ™‚ (30s)' : e.message);
                }
            };

            try {
                const key = appState.keys[model];
                if(!key && model !== 'zeabur') throw new Error(`è«‹è¨­å®š ${model} API Key`);

                if(model === 'gemini') {
                    if(!appState.detectedGeminiModel) appState.detectedGeminiModel = await detectAvailableGeminiModel(key);
                    const modelName = appState.detectedGeminiModel.replace('models/', '');
                    
                    const payload = { 
                        contents: [{ parts: [{ text: userText }] }],
                        generationConfig: { temperature: 0.7, maxOutputTokens: 4096 }
                    };

                    if (appState.isSearchEnabled || options.enableSearch) {
                        payload.tools = [{ google_search: {} }];
                    }

                    const res = await fetchWithTimeout(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });
                    
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);

                    const candidate = data.candidates?.[0];
                    if (!candidate) return "âš ï¸ API æœªå›å‚³å…§å®¹ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚";

                    // è§£ææ–‡å­—
                    let outputText = "";
                    if (candidate.content && candidate.content.parts) {
                        outputText = candidate.content.parts.filter(p => p.text).map(p => p.text).join("");
                    }

                    // è§£æä¾†æº (Grounding)
                    let sources = [];
                    if (candidate.groundingMetadata?.groundingAttributions) {
                        candidate.groundingMetadata.groundingAttributions.forEach(attr => {
                            if (attr.web?.uri) sources.push({ title: attr.web.title || "åƒè€ƒé€£çµ", uri: attr.web.uri });
                        });
                    }

                    if (!outputText && sources.length > 0) outputText = "å·²ç‚ºæ‚¨æœå°‹åˆ°ç›¸é—œè³‡è¨Šï¼Œè«‹åƒè€ƒä¾†æºé€£çµã€‚";
                    else if (!outputText) outputText = "(ç„¡å›å‚³æ–‡å­—å…§å®¹)";

                    return { text: outputText, sources: sources };

                } else if (model === 'openrouter') {
                    const res = await fetchWithTimeout('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: appState.openRouterModel, messages: [{ role: 'user', content: userText }] })
                    });
                    const data = await res.json();
                    return data.choices?.[0]?.message?.content || "ç„¡å›æ‡‰";
                }
                // ... å…¶ä»–æ¨¡å‹é‚è¼¯ (Cerebras, GPT ç­‰) ä¾æ­¤é¡æ¨
            } catch(e) { throw e; }
        }

        async function detectAvailableGeminiModel(apiKey) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const data = await res.json();
                const models = data.models.filter(m => m.supportedGenerationMethods?.includes("generateContent"));
                return (models.find(m=>m.name.includes("gemini-1.5-flash")) || models[0]).name;
            } catch(e) { return 'gemini-1.5-flash'; }
        }

        // --- ACTIONS ---
        async function handleSendMessage() {
            if(appState.isThinking) return;
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if(!text) return;

            appState.isThinking = true;
            updateSendButtonState(true);
            addMessage(text, 'user');
            input.value = '';
            renderThinkingState(true);

            try {
                const res = await fetchAIResponse(text, appState.currentModel);
                if(typeof res === 'string') addMessage(res, 'ai', appState.currentModel);
                else addMessage(res.text, 'ai', appState.currentModel, res.sources);
            } catch (error) {
                addMessage(`[ç³»çµ±éŒ¯èª¤] ${error.message}`, 'system');
            } finally {
                appState.isThinking = false;
                updateSendButtonState(false);
                renderThinkingState(false);
            }
        }

        function addMessage(text, sender, model, sources=[]) { 
            appState.messages.push({id:Date.now(), text, sender, model, sources, time:getTime()}); 
            saveMessages(); 
            renderMessages(); 
        }

        function setModel(m){ appState.currentModel=m; updateModelUI(); }
        function toggleSearch() { appState.isSearchEnabled = !appState.isSearchEnabled; updateModelUI(); }
        
        function updateModelUI(){ 
            const conf=MODEL_CONFIG[appState.currentModel]; 
            document.getElementById('status-name').innerText=conf.name; 
            document.getElementById('status-icon').className=`ph-fill ${conf.icon} text-lg ${conf.color}`; 
            document.querySelectorAll('.model-pill').forEach(b=>{ 
                b.className = `model-pill px-3 py-1 rounded-lg text-[10px] font-bold ${b.dataset.model===appState.currentModel ? `${conf.bg} text-white` : 'bg-slate-800 text-slate-400'} transition-all whitespace-nowrap`; 
            }); 
            const badge=document.getElementById('web-search-badge');
            const hint=document.getElementById('search-hint');
            if(appState.isSearchEnabled){ badge.classList.remove('hidden'); hint.classList.remove('hidden'); }
            else { badge.classList.add('hidden'); hint.classList.add('hidden'); }
        }

        function handleEnter(e) { if(e.key === 'Enter') handleSendMessage(); }
        function updateSendButtonState(isLoading) { 
            const btn=document.getElementById('send-btn'), icon=document.getElementById('send-icon'); 
            if(isLoading){ btn.disabled=true; icon.className='ph-bold ph-spinner animate-spin'; }
            else { btn.disabled=false; icon.className='ph-bold ph-paper-plane-right'; }
        }

        function switchTab(id){ 
            ['dashboard','schedule','notes'].forEach(t=>document.getElementById(`view-${t}`).classList.add('hidden')); 
            document.getElementById(`view-${id}`).classList.remove('hidden'); 
            document.getElementById(`view-${id}`).classList.add('flex'); 
        }

        function openSettings(){document.getElementById('settings-modal').classList.remove('hidden');}
        function closeSettings(){document.getElementById('settings-modal').classList.add('hidden');}
        
        function saveKeys(){ 
            appState.keys.gemini=document.getElementById('key-gemini').value.trim(); 
            appState.keys.openrouter=document.getElementById('key-openrouter').value.trim();
            localStorage.setItem('nova_key_gemini',appState.keys.gemini); 
            localStorage.setItem('nova_key_openrouter',appState.keys.openrouter); 
            closeSettings(); 
            addMessage("è¨­å®šå·²å„²å­˜", 'system'); 
        }

        // --- INIT ---
        window.onload = () => {
            if(appState.messages.length === 0) {
                appState.messages.push({ id: 1, text: 'Nova 12.30.2 å°±ç·’ï¼ä¿®æ­£äº† Gemini è¯ç¶²æœå°‹é‚è¼¯ã€‚', sender: 'ai', model: 'gemini', time: getTime() });
            }
            renderMessages();
            updateModelUI();
            document.getElementById('key-gemini').value = appState.keys.gemini;
            document.getElementById('key-openrouter').value = appState.keys.openrouter;
        };
    </script>
</body>
</html>
