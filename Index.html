<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nova 11.0 - çµ‚æ¥µä¿®å¾©ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { slate: { 925: '#0f172a' } },
                    animation: { 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'spin-slow': 'spin 2s linear infinite' }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        .dot-flashing {
            position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #9880ff; color: #9880ff;
            animation: dot-flashing 1s infinite linear alternate; animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: ""; display: inline-block; position: absolute; top: 0; width: 6px; height: 6px; border-radius: 5px; background-color: #9880ff; color: #9880ff; animation: dot-flashing 1s infinite alternate;
        }
        .dot-flashing::before { left: -10px; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { background-color: #9880ff; } 50%, 100% { background-color: rgba(152, 128, 255, 0.2); } }
        .msg-content a { color: #60a5fa; text-decoration: underline; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans overflow-hidden selection:bg-blue-500/30">

    <div class="flex h-[100dvh] w-full">
        <aside class="hidden md:flex flex-col w-64 bg-slate-900 border-r border-slate-800 p-6 flex-shrink-0">
            <div class="flex items-center space-x-3 mb-10 px-2">
                <div class="w-10 h-10 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i class="ph-bold ph-magic-wand text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white tracking-wide">NOVA</h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider">Ultimate Fix v11</p>
                </div>
            </div>
            <nav class="flex-1 space-y-2">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg transition-all"><i class="ph ph-chats-circle text-xl"></i><span class="font-medium">åŠ©ç†å°è©±</span></button>
                <button onclick="switchTab('schedule')" id="nav-schedule" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all"><i class="ph ph-calendar-check text-xl"></i><span class="font-medium">è¡Œç¨‹ç®¡ç†</span></button>
                <button onclick="switchTab('notes')" id="nav-notes" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all"><i class="ph ph-notebook text-xl"></i><span class="font-medium">ç­†è¨˜ä¸­å¿ƒ</span></button>
            </nav>
            <div class="mt-auto space-y-3">
                <button onclick="openSettings()" class="flex items-center space-x-2 text-xs text-slate-500 hover:text-slate-300 w-full px-2"><i class="ph ph-gear"></i><span>API è¨­å®š</span></button>
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                    <div class="flex items-center space-x-2"><i id="status-icon" class="ph-fill ph-globe text-blue-400 text-lg"></i><span id="status-name" class="font-bold text-sm">Gemini</span></div>
                    <p id="model-version-display" class="text-[10px] text-slate-500 mt-1">Ready</p>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-slate-950 overflow-hidden min-h-0">
            <div class="md:hidden flex items-center justify-between p-3 bg-slate-900 border-b border-slate-800 z-30 shrink-0">
                <div class="flex items-center space-x-2"><i class="ph-bold ph-magic-wand text-blue-500 text-xl"></i><span class="font-bold text-white">Nova</span></div>
                <div class="flex items-center space-x-2 bg-slate-800/50 px-2 py-1 rounded-lg border border-slate-700/50 cursor-pointer active:scale-95 transition-transform" onclick="cycleManualLocation()">
                    <i id="mobile-weather-icon" class="ph-fill ph-navigation-arrow text-blue-400"></i><span id="mobile-weather-temp" class="text-xs font-bold text-white">æ›´æ–°</span>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="openSettings()"><i class="ph ph-gear text-slate-400 text-xl"></i></button>
                    <button onclick="toggleMobileMenu()"><i class="ph ph-list text-white text-2xl"></i></button>
                </div>
            </div>

            <div id="mobile-menu" class="hidden md:hidden fixed inset-0 z-40 bg-slate-950/95 pt-20 px-6 backdrop-blur-md">
                <nav class="space-y-4">
                    <button onclick="switchTab('dashboard'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl bg-slate-800 text-white"><i class="ph ph-chats-circle text-xl"></i><span>åŠ©ç†å°è©±</span></button>
                    <button onclick="switchTab('schedule'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800"><i class="ph ph-calendar-check text-xl"></i><span>è¡Œç¨‹ç®¡ç†</span></button>
                    <button onclick="switchTab('notes'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800"><i class="ph ph-notebook text-xl"></i><span>ç­†è¨˜ä¸­å¿ƒ</span></button>
                </nav>
            </div>

            <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-slate-950/90 backdrop-blur-sm flex items-center justify-center p-4">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-md shadow-2xl">
                    <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white">API è¨­å®š</h3><button onclick="closeSettings()"><i class="ph ph-x text-2xl text-slate-400"></i></button></div>
                    <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                        <div class="bg-blue-900/20 p-3 rounded border border-blue-800/50 mb-4">
                            <p class="text-xs text-blue-300">ğŸ’¡ æç¤ºï¼šè‹¥é‡åˆ°ã€Œç„¡å…§å®¹ã€ï¼Œç³»çµ±å°‡è‡ªå‹•é‡è©¦ã€‚å¤©æ°£è‹¥ç„¡æ³•è‡ªå‹•å®šä½ï¼Œè«‹é»æ“Šå¤©æ°£å¡ç‰‡æ‰‹å‹•åˆ‡æ›ã€‚</p>
                        </div>
                        <div><label class="block text-xs text-blue-400 mb-1">Gemini API Key</label><input type="password" id="key-gemini" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none" placeholder="AIzaSy..."></div>
                        <div><label class="block text-xs text-orange-400 mb-1">Cerebras API Key</label><input type="password" id="key-cerebras" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-sm focus:border-orange-500 outline-none" placeholder="csk-..."></div>
                        <div><label class="block text-xs text-emerald-400 mb-1">OpenAI API Key</label><input type="password" id="key-openai" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-sm focus:border-emerald-500 outline-none" placeholder="sk-..."></div>
                        <div><label class="block text-xs text-slate-300 mb-1">Grok API Key</label><input type="password" id="key-grok" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-sm focus:border-slate-500 outline-none" placeholder="xai-..."></div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3"><button onclick="closeSettings()" class="px-4 py-2 text-slate-400 text-sm">å–æ¶ˆ</button><button onclick="saveKeys()" class="px-6 py-2 bg-blue-600 text-white rounded-lg">å„²å­˜</button></div>
                </div>
            </div>

            <div id="view-dashboard" class="flex flex-col lg:flex-row h-full w-full relative min-h-0">
                <div class="flex-1 flex flex-col h-full min-w-0 relative">
                    <div class="p-3 border-b border-slate-800 bg-slate-900/50 backdrop-blur-sm flex justify-between items-center shrink-0 overflow-x-auto no-scrollbar">
                         <div class="flex items-center space-x-2 mr-4">
                            <span id="web-search-badge" class="hidden md:flex items-center space-x-1 text-[10px] bg-blue-900/30 text-blue-400 border border-blue-500/30 px-2 py-0.5 rounded-full"><i class="ph-bold ph-globe"></i><span>é€£ç¶²æœå°‹</span></span>
                         </div>
                         <div class="flex space-x-1">
                            <button onclick="setModel('gemini')" class="model-pill px-2 py-1 rounded text-[10px] font-bold bg-blue-600 text-white" data-model="gemini">Gemini</button>
                            <button onclick="setModel('cerebras')" class="model-pill px-2 py-1 rounded text-[10px] font-bold bg-slate-800 text-slate-400" data-model="cerebras">Cerebras</button>
                            <button onclick="setModel('gpt')" class="model-pill px-2 py-1 rounded text-[10px] font-bold bg-slate-800 text-slate-400" data-model="gpt">GPT</button>
                            <button onclick="setModel('grok')" class="model-pill px-2 py-1 rounded text-[10px] font-bold bg-slate-800 text-slate-400" data-model="grok">Grok</button>
                         </div>
                    </div>
                    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 scrollbar-thin scrollbar-thumb-slate-700"></div>
                    
                    <div class="p-4 bg-slate-900 border-t border-slate-800 shrink-0 z-20 pb-[calc(1rem+env(safe-area-inset-bottom))]">
                        <div id="input-wrapper" class="flex items-center bg-slate-950 rounded-xl px-2 py-2 border border-slate-700 focus-within:border-blue-500 transition-colors">
                            <button id="search-toggle-btn" onclick="toggleSearch()" class="p-3 rounded-lg text-slate-500 hover:text-blue-400 hover:bg-slate-800 transition-all flex-shrink-0 mr-1" title="åˆ‡æ›æœå°‹"><i id="search-icon" class="ph-bold ph-globe text-xl"></i></button>
                            <button id="voice-btn" onclick="toggleVoice()" class="p-3 mr-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-all active:scale-95 flex-shrink-0"><i id="voice-icon" class="ph-bold ph-microphone text-xl"></i></button>
                            <input type="text" id="user-input" placeholder="è¼¸å…¥è¨Šæ¯..." class="flex-1 bg-transparent border-none focus:ring-0 text-white outline-none h-full" onkeydown="handleEnter(event)">
                            <button onclick="handleSendMessage()" id="send-btn" class="ml-2 p-3 rounded-lg text-white bg-blue-600 hover:opacity-90 flex-shrink-0 transition-all"><i id="send-icon" class="ph-bold ph-paper-plane-right"></i></button>
                        </div>
                        <div id="search-hint" class="text-[10px] text-blue-400 mt-2 text-center hidden">ğŸŒ å·²é–‹å•Ÿé€£ç¶²æœå°‹æ¨¡å¼ (åƒ…æ”¯æ´ Gemini)</div>
                    </div>
                </div>
                
                <div class="hidden lg:flex w-80 bg-slate-900 flex-col p-6 space-y-6 border-l border-slate-800 overflow-y-auto shrink-0">
                    <div class="bg-gradient-to-br from-indigo-900 to-slate-800 rounded-3xl p-6 text-white shadow-lg border border-slate-700 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/20 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-slate-300 text-xs font-bold uppercase mb-1">ç›®å‰å¤©æ°£</h3>
                                    <div class="flex items-center space-x-2 cursor-pointer hover:opacity-80 transition-opacity" onclick="cycleManualLocation()">
                                        <i class="ph-fill ph-map-pin text-blue-400"></i>
                                        <span id="location-name" class="text-lg font-bold text-white border-b border-dashed border-slate-500">æœªå®šä½</span>
                                    </div>
                                    <p id="location-status" class="text-[10px] text-slate-400 mt-1">é»æ“Šåœ°é»å¯æ‰‹å‹•åˆ‡æ›</p>
                                </div>
                                <i id="weather-icon" class="ph-fill ph-cloud-sun text-4xl text-yellow-400"></i>
                            </div>
                            <div class="mt-4 flex items-end space-x-2"><span id="weather-temp" class="text-5xl font-bold">--Â°</span><span id="weather-desc" class="text-slate-300 text-sm mb-2">--</span></div>
                            <div class="mt-4 grid grid-cols-2 gap-2 text-xs text-slate-300"><span id="weather-humidity">æ¿•åº¦ --%</span><span id="weather-wind">é¢¨é€Ÿ --km/h</span></div>
                        </div>
                    </div>
                    <div class="bg-slate-950 rounded-2xl p-5 border border-slate-800">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-200 text-sm flex items-center gap-2"><i class="ph-fill ph-calendar-check text-blue-500"></i>è¿‘æœŸä»»å‹™</h3><button onclick="switchTab('schedule')" class="text-xs text-blue-400">ç®¡ç†</button></div>
                        <div id="mini-todo-list" class="space-y-2"></div>
                    </div>
                    <div class="bg-slate-950 rounded-2xl p-5 border border-slate-800">
                         <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-200 text-sm flex items-center gap-2"><i class="ph-fill ph-notebook text-emerald-500"></i>æœ€æ–°ç­†è¨˜</h3><button onclick="switchTab('notes')" class="text-xs text-blue-400">æŸ¥çœ‹</button></div>
                        <div id="mini-note-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div id="view-schedule" class="hidden flex-col h-full w-full p-6 overflow-y-auto"><div class="max-w-3xl mx-auto w-full"><header class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">è¡Œç¨‹ç®¡ç†</h2><button onclick="addTodoManually()" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2"><i class="ph-bold ph-plus"></i><span>æ–°å¢</span></button></header><div id="full-todo-list" class="space-y-3"></div></div></div>
            <div id="view-notes" class="hidden flex-col h-full w-full p-6 overflow-y-auto"><div class="max-w-5xl mx-auto w-full"><header class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">ç­†è¨˜ä¸­å¿ƒ</h2><button onclick="addNoteManually()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2"><i class="ph-bold ph-plus"></i><span>æ–°å¢</span></button></header><div id="full-note-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div></div>
        </main>
    </div>

    <script>
        const appState = {
            currentModel: 'gemini', detectedGeminiModel: null,
            messages: [{ id: 1, text: 'Nova 11.0 ç³»çµ±å°±ç·’ã€‚\n\nğŸ’¡ è‹¥æœå°‹å›å‚³ã€Œç„¡å…§å®¹ã€ï¼Œç³»çµ±å°‡è‡ªå‹•é‡è©¦ä¸¦é—œé–‰æœå°‹å·¥å…·ä»¥ç¢ºä¿å›ç­”ã€‚\n\nğŸ“ è‹¥å®šä½å¤±æ•—ï¼Œå°‡è‡ªå‹•é è¨­ç‚ºå°åŒ—ï¼Œæ‚¨å¯é»æ“Šåœ°é»åç¨±æ‰‹å‹•åˆ‡æ›ã€‚', sender: 'ai', model: 'gemini', time: getTime() }],
            todos: [], notes: [],
            weather: { temp: '--', condition: 'cloudy', humidity: '--', wind: '--', loc: 'æœªå®šä½' },
            keys: { gemini: localStorage.getItem('nova_key_gemini')||'', cerebras: localStorage.getItem('nova_key_cerebras')||'', openai: localStorage.getItem('nova_key_openai')||'', grok: localStorage.getItem('nova_key_grok')||'' },
            isThinking: false, isListening: false, isSearchEnabled: false,
            manualLocIndex: 0,
            manualLocs: [{name: "å°åŒ—", lat: 25.0330, lon: 121.5654}, {name: "å°ä¸­", lat: 24.1477, lon: 120.6736}, {name: "é«˜é›„", lat: 22.6273, lon: 120.3014}]
        };
        const MODEL_CONFIG = {
            gemini: { name: 'Gemini', color: 'text-blue-400', bg: 'bg-blue-600', icon: 'ph-sparkle' },
            cerebras: { name: 'Cerebras', color: 'text-orange-400', bg: 'bg-orange-600', icon: 'ph-rocket-launch' },
            gpt: { name: 'ChatGPT', color: 'text-emerald-400', bg: 'bg-emerald-600', icon: 'ph-cpu' },
            grok: { name: 'Grok', color: 'text-slate-100', bg: 'bg-slate-600', icon: 'ph-lightning' }
        };

        window.onload = () => {
            renderAll();
            document.getElementById('key-gemini').value = appState.keys.gemini;
            document.getElementById('key-cerebras').value = appState.keys.cerebras;
            document.getElementById('key-openai').value = appState.keys.openai;
            document.getElementById('key-grok').value = appState.keys.grok;
            tryGetLocation(true); 
            updateModelUI();
        };

        function getTime() { return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

        // --- ğŸŒ ROBUST LOCATION LOGIC (GPS -> IP -> Default Fallback) ---
        
        async function tryGetLocation(silent=false) {
            updateLocStatus("å®šä½ä¸­...");
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (p) => fetchWeather(p.coords.latitude, p.coords.longitude, "GPS", silent), 
                    (e) => { console.warn("GPS Fail", e); getIPLocation(silent); },
                    { timeout: 5000 }
                );
            } else getIPLocation(silent);
        }

        async function getIPLocation(silent) {
            updateLocStatus("IPå®šä½...");
            try {
                // Primary: ipapi.co (HTTPS only)
                const res = await fetch('https://ipapi.co/json/');
                if (!res.ok) throw new Error();
                const data = await res.json();
                fetchWeather(data.latitude, data.longitude, `${data.city} (IP)`, silent);
            } catch (e) {
                // Secondary: ipwho.is
                try {
                    const res2 = await fetch('https://ipwho.is/');
                    const data2 = await res2.json();
                    if(!data2.success) throw new Error();
                    fetchWeather(data2.latitude, data2.longitude, `${data2.city} (IP)`, silent);
                } catch(e2) {
                    // FINAL FALLBACK: Default to Taipei
                    const def = appState.manualLocs[0];
                    fetchWeather(def.lat, def.lon, def.name + " (é è¨­)", true);
                    if(!silent) addMessage("âš ï¸ å®šä½å¤±æ•—ï¼Œå·²åˆ‡æ›è‡³é è¨­åŸå¸‚", "system");
                }
            }
        }

        function cycleManualLocation() {
            appState.manualLocIndex = (appState.manualLocIndex + 1) % appState.manualLocs.length;
            const loc = appState.manualLocs[appState.manualLocIndex];
            fetchWeather(loc.lat, loc.lon, loc.name + " (æ‰‹å‹•)", false);
        }

        async function fetchWeather(lat, lon, locName, silent) {
            updateLocStatus("æ›´æ–°å¤©æ°£...");
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`;
                const res = await fetch(url); const data = await res.json();
                if(data.current) {
                    const c = data.current;
                    appState.weather = { temp: Math.round(c.temperature_2m), humidity: c.relative_humidity_2m, wind: c.wind_speed_10m, condition: wmoToCondition(c.weather_code), loc: locName };
                    renderWeather(); updateLocStatus("å·²æ›´æ–°");
                    if(!silent) addMessage(`âœ… å¤©æ°£æ›´æ–° (${locName}): ${c.temperature_2m}Â°C`, "system");
                }
            } catch(e) { updateLocStatus("éŒ¯èª¤"); }
        }

        function updateLocStatus(msg) {
            document.getElementById('location-status').innerText = msg;
            if(msg==="å·²æ›´æ–°" || msg.includes("é è¨­") || msg.includes("æ‰‹å‹•")) {
                const {loc, temp} = appState.weather;
                document.getElementById('location-name').innerText = loc;
                document.getElementById('mobile-weather-temp').innerText = `${temp}Â°`;
            }
        }
        function wmoToCondition(code) { if(code===0)return 'sunny'; if(code<=48)return 'cloudy'; if(code<=82)return 'rainy'; if(code<=77)return 'snow'; return 'storm'; }

        // --- HANDLER & SEARCH FALLBACK ---
        
        function handleEnter(e) { if(e.key==='Enter') handleSendMessage(); }
        
        async function handleSendMessage() {
            if(appState.isThinking) return;
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if(!text) return;
            
            if(text.includes('å¤©æ°£')) { tryGetLocation(false); }

            addMessage(text, 'user');
            input.value = '';
            
            appState.isThinking = true;
            updateSendButtonState(true);
            renderThinkingState(true);

            try {
                let systemPromptAddon = "";
                const navMatch = text.match(/(å°èˆª|å¸¶æˆ‘å»|æ€éº¼å»|è·¯ç·š|å‰å¾€)\s*(.+)/i);
                if (navMatch) {
                    const dest = navMatch[2].replace(/åˆ°|å»/g, '').trim();
                    appState.messages.push({ id:Date.now(), sender:'system', type:'nav', text:`å‰å¾€ï¼š${dest}`, url:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dest)}`, time:getTime() });
                    renderMessages(); systemPromptAddon = `(ç³»çµ±: å·²ç”¢ç”Ÿå°èˆªå¡ç‰‡)`; 
                } else if (text.match(/^(æé†’æˆ‘|è¡Œç¨‹|ä»»å‹™|todo)\s*(.+)/i) || text.includes('æé†’')) {
                    let content = text.match(/^(æé†’æˆ‘|è¡Œç¨‹|ä»»å‹™|todo)\s*(.+)/i)?.[2] || text.replace(/æé†’æˆ‘|æé†’/g, '').trim();
                    if(content) { appState.todos.push({id:Date.now(), text:content, done:false, time:'å‰›å‰›'}); renderTodos(); addMessage(`å·²æ–°å¢ï¼š${content}`, 'system'); systemPromptAddon = `(ç³»çµ±: å·²æ–°å¢å¾…è¾¦)`; }
                } else if (text.match(/^(ç­†è¨˜|ç´€éŒ„|è¨˜éŒ„|note)\s*(.+)/i)) {
                    let content = text.match(/^(ç­†è¨˜|ç´€éŒ„|è¨˜éŒ„|note)\s*(.+)/i)?.[2];
                    if(content) { appState.notes.push({id:Date.now(), title:content.substring(0,10)+'...', content, date:new Date().toLocaleDateString()}); renderNotes(); addMessage(`å·²ç­†è¨˜`, 'system'); systemPromptAddon = `(ç³»çµ±: å·²å„²å­˜ç­†è¨˜)`; }
                }

                const prompt = systemPromptAddon ? `${text}\n${systemPromptAddon}` : text;
                const res = await fetchAIResponse(prompt, appState.currentModel);
                
                if(typeof res === 'string') addMessage(res, 'ai', appState.currentModel);
                else addMessage(res.text, 'ai', appState.currentModel, res.sources);

            } catch (error) {
                console.error("Handler Error:", error);
                addMessage(`[ç³»çµ±éŒ¯èª¤] ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'system');
            } finally {
                appState.isThinking = false;
                updateSendButtonState(false);
                renderThinkingState(false);
            }
        }

        function updateSendButtonState(isLoading) {
            const btn = document.getElementById('send-btn');
            const icon = document.getElementById('send-icon');
            if(isLoading) { btn.classList.add('cursor-not-allowed', 'opacity-70'); icon.classList.remove('ph-paper-plane-right'); icon.classList.add('ph-spinner', 'animate-spin'); }
            else { btn.classList.remove('cursor-not-allowed', 'opacity-70'); icon.classList.remove('ph-spinner', 'animate-spin'); icon.classList.add('ph-paper-plane-right'); }
        }

        async function fetchAIResponse(userText, model) {
            const key = appState.keys[model];
            if(!key) throw new Error(`è«‹è¨­å®š ${MODEL_CONFIG[model].name} API Key`);
            const fetchWithTimeout = async (url, options, timeout = 15000) => {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                try { const response = await fetch(url, { ...options, signal: controller.signal }); clearTimeout(id); return response; } 
                catch (error) { clearTimeout(id); throw new Error(error.name === 'AbortError' ? 'é€£ç·šé€¾æ™‚' : error.message); }
            };

            try {
                if(model === 'gemini') {
                    if(!appState.detectedGeminiModel) appState.detectedGeminiModel = await detectAvailableGeminiModel(key);
                    const name = appState.detectedGeminiModel.replace('models/', '');
                    
                    // Force text only if search disabled
                    const payload = { contents:[{parts:[{text:userText}]}] };
                    if (appState.isSearchEnabled) payload.tools = [{google_search:{}}];

                    const res = await fetchWithTimeout(`https://generativelanguage.googleapis.com/v1beta/models/${name}:generateContent?key=${key}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                    const data = await res.json();
                    
                    // --- SEARCH FALLBACK MECHANISM ---
                    // If error or no text content, retry WITHOUT search tools
                    if(data.error || !data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        if (appState.isSearchEnabled) { 
                            // Add system log
                            addMessage(`âš ï¸ æœå°‹ç„¡çµæœæˆ–è¢«é˜»æ“‹ï¼Œæ­£å˜—è©¦ç´”æ–‡å­—æ¨¡å¼...`, 'system');
                            const retry = await fetchWithTimeout(`https://generativelanguage.googleapis.com/v1beta/models/${name}:generateContent?key=${key}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents:[{parts:[{text:userText}]}] }) });
                            const d = await retry.json();
                            return (d.candidates?.[0]?.content?.parts?.[0]?.text) || `[API Error] ${d.error?.message || 'ç„¡å…§å®¹'}`;
                        }
                        throw new Error(data.error?.message || 'ç„¡å…§å®¹');
                    }
                    
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    let sources = []; data.candidates?.[0]?.groundingMetadata?.groundingAttributions?.forEach(a => { if(a.web?.uri) sources.push({title:a.web.title, uri:a.web.uri}); });
                    return {text, sources};
                } 
                // Other models logic...
                else if(model === 'cerebras') {
                    const res = await fetchWithTimeout('https://api.cerebras.ai/v1/chat/completions', { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${key}`}, body: JSON.stringify({model:"llama-3.3-70b", messages:[{role:"user", content:userText}], stream:false}) });
                    const data = await res.json(); if(data.error) throw new Error(data.error.message); return data.choices[0].message.content;
                } else {
                    const ep = model==='gpt'?'https://api.openai.com/v1/chat/completions':'https://api.x.ai/v1/chat/completions';
                    const mName = model==='gpt'?'gpt-4o-mini':'grok-beta';
                    const res = await fetchWithTimeout(ep, { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${key}`}, body: JSON.stringify({model:mName, messages:[{role:"user", content:userText}]}) });
                    const data = await res.json(); if(data.error) throw new Error(data.error.message); return data.choices[0].message.content;
                }
            } catch(e) { throw e; }
        }

        async function detectAvailableGeminiModel(apiKey) {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            const models = data.models.filter(m => m.supportedGenerationMethods?.includes("generateContent"));
            return (models.find(m=>m.name.includes("gemini-1.5-flash")) || models.find(m=>m.name.includes("gemini-1.5-pro")) || models[0]).name;
        }

        // --- Standard Functions ---
        function toggleSearch() { appState.isSearchEnabled = !appState.isSearchEnabled; updateModelUI(); }
        let recognition = null;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) { const SR = window.SpeechRecognition || window.webkitSpeechRecognition; recognition = new SR(); recognition.lang = 'zh-TW'; recognition.onstart = () => {appState.isListening=true;updateVoiceUI();}; recognition.onend = () => {appState.isListening=false;updateVoiceUI();}; recognition.onresult = (e) => {document.getElementById('user-input').value = e.results[0][0].transcript; setTimeout(()=>handleSendMessage(),500);}; }
        function toggleVoice() { if(!recognition){alert("ç€è¦½å™¨ä¸æ”¯æ´");return;} if(appState.isListening)recognition.stop(); else recognition.start(); }
        function updateVoiceUI() { const btn=document.getElementById('voice-btn'),icon=document.getElementById('voice-icon'); if(appState.isListening){btn.classList.add('text-red-500','animate-pulse-fast');icon.classList.replace('ph-microphone','ph-microphone-stage');}else{btn.classList.remove('text-red-500','animate-pulse-fast');icon.classList.replace('ph-microphone-stage','ph-microphone');} }

        function renderAll() { renderMessages(); renderTodos(); renderNotes(); renderWeather(); }
        function renderMessages() {
            document.getElementById('chat-container').innerHTML = appState.messages.map(msg => {
                if (msg.sender === 'system') {
                    if (msg.type === 'nav') return `<div class="flex justify-center fade-in my-3"><a href="${msg.url}" target="_blank" class="bg-blue-900/40 border border-blue-500/50 p-4 rounded-xl flex items-center space-x-4 cursor-pointer hover:bg-blue-900/60 w-[80%]"><div class="bg-blue-600 rounded-full p-3"><i class="ph-fill ph-navigation-arrow text-white text-xl"></i></div><div class="flex-1"><p class="text-blue-200 text-xs font-bold mb-1">é–‹å§‹å°èˆª</p><p class="text-white font-bold text-lg truncate">${escapeHtml(msg.text.replace('å‰å¾€ï¼š', ''))}</p></div><i class="ph-bold ph-arrow-right text-blue-400"></i></a></div>`;
                    return `<div class="flex justify-center fade-in my-2"><div class="bg-slate-800/80 border border-slate-700 text-slate-300 text-xs py-1.5 px-4 rounded-full flex items-center space-x-2"><i class="ph-fill ph-info"></i><span>${escapeHtml(msg.text)}</span></div></div>`;
                }
                const isUser = msg.sender === 'user'; const modelInfo = isUser ? null : MODEL_CONFIG[msg.model];
                let sourcesHTML = ''; if (msg.sources?.length) sourcesHTML = `<div class="mt-3 pt-3 border-t border-slate-700/50"><p class="text-[10px] text-slate-400 mb-1 font-bold">ä¾†æºï¼š</p><div class="flex flex-wrap gap-2">${msg.sources.map((s,i)=>`<a href="${s.uri}" target="_blank" class="text-[10px] bg-slate-950/50 text-blue-400 px-2 py-1 rounded border border-slate-700/50 block truncate max-w-[150px]">${i+1}. ${s.title}</a>`).join('')}</div></div>`;
                return `<div class="flex ${isUser ? 'justify-end' : 'justify-start items-start space-x-3'} fade-in">${!isUser ? `<div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 mt-1 ${modelInfo.bg}"><i class="ph-fill ${modelInfo.icon} text-white text-sm"></i></div>` : ''}<div class="max-w-[90%] md:max-w-[80%] rounded-2xl p-4 shadow-sm ${isUser ? 'bg-slate-800 text-white rounded-br-none' : 'bg-slate-900 border border-slate-800 text-slate-200 rounded-tl-none'}">${!isUser ? `<span class="text-[10px] font-bold uppercase mb-1 block ${modelInfo.color} opacity-80">${modelInfo.name}</span>` : ''}<div class="msg-content text-sm leading-relaxed">${escapeHtml(msg.text).replace(/\n/g, '<br>')}</div>${sourcesHTML}<p class="text-[10px] mt-2 text-right text-slate-500 opacity-60">${msg.time}</p></div></div>`;
            }).join(''); document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
        }
        function addMessage(text, sender, model, sources=[]) { appState.messages.push({id:Date.now(), text, sender, model, sources, time:getTime()}); renderMessages(); }
        function renderThinkingState(show) { const el = document.getElementById('thinking-indicator'); if(show && !el) document.getElementById('chat-container').insertAdjacentHTML('beforeend', `<div id="thinking-indicator" class="flex justify-start items-center space-x-3 fade-in"><div class="w-8 h-8 rounded-full flex items-center justify-center ${MODEL_CONFIG[appState.currentModel].bg}"><i class="ph-fill ${MODEL_CONFIG[appState.currentModel].icon} text-white text-sm"></i></div><div class="bg-slate-900 border border-slate-800 p-4 rounded-2xl rounded-tl-none"><div class="dot-flashing ml-2"></div></div></div>`); else if(!show && el) el.remove(); }
        
        function renderTodos() { document.getElementById('full-todo-list').innerHTML=appState.todos.map(t=>`<div class="group bg-slate-900 p-4 rounded-xl border border-slate-800 flex justify-between hover:border-slate-600 transition-all slide-in"><div class="flex items-center space-x-4"><button onclick="toggleTodo(${t.id})" class="text-slate-500 hover:text-blue-400"><i class="ph${t.done?'-fill ph-check-circle text-green-500':' ph-circle'} text-2xl"></i></button><div><p class="text-base ${t.done?'line-through text-slate-600':'text-slate-200'}">${escapeHtml(t.text)}</p><span class="text-xs text-slate-500">${t.time}</span></div></div><button onclick="deleteTodo(${t.id})" class="text-slate-500 hover:text-red-400 p-2"><i class="ph ph-trash"></i></button></div>`).join('')||'<p class="text-slate-500 text-center mt-10">ç„¡ä»»å‹™</p>'; document.getElementById('mini-todo-list').innerHTML=appState.todos.slice(0,3).map(t=>`<div class="flex items-center space-x-3 p-2 bg-slate-950/50 rounded-lg border border-slate-800/50"><div class="w-1.5 h-8 rounded-full ${t.done?'bg-green-500':'bg-blue-500'}"></div><div class="flex-1 min-w-0"><p class="text-xs truncate ${t.done?'line-through text-slate-600':'text-slate-300'}">${escapeHtml(t.text)}</p></div></div>`).join('')||'<p class="text-xs text-slate-500 text-center">ç„¡å¾…è¾¦</p>'; }
        function renderNotes() { document.getElementById('full-note-list').innerHTML=appState.notes.map(n=>`<div class="bg-slate-900 p-6 rounded-2xl border border-slate-800 hover:border-slate-600 flex flex-col h-48 relative overflow-hidden slide-in"><div class="flex justify-between mb-2"><h3 class="text-lg font-bold text-white truncate pr-2">${escapeHtml(n.title)}</h3><span class="text-xs text-slate-500 whitespace-nowrap">${n.date}</span></div><p class="text-slate-300 text-sm overflow-y-auto flex-1 scrollbar-thin">${escapeHtml(n.content)}</p><button onclick="deleteNote(${n.id})" class="absolute bottom-4 right-4 text-slate-600 hover:text-red-400"><i class="ph ph-trash text-lg"></i></button></div>`).join('')||'<p class="text-slate-500 text-center col-span-3 mt-10">ç„¡ç­†è¨˜</p>'; document.getElementById('mini-note-list').innerHTML=appState.notes.slice(0,2).map(n=>`<div class="bg-slate-950/50 p-3 rounded-lg border border-slate-800/50 cursor-pointer hover:border-slate-700" onclick="switchTab('notes')"><h4 class="text-slate-300 text-xs font-bold mb-1 truncate">${escapeHtml(n.title)}</h4><p class="text-slate-500 text-[10px] line-clamp-1">${escapeHtml(n.content)}</p></div>`).join('')||'<p class="text-xs text-slate-500 text-center">ç„¡ç­†è¨˜</p>'; }
        function renderWeather() { const {temp,condition,humidity,wind,loc}=appState.weather; let icon='ph-cloud',color='text-slate-400',desc='å¤šé›²'; if(condition==='sunny'){icon='ph-sun';color='text-yellow-400';desc='æ™´æœ—';} if(condition==='rainy'){icon='ph-cloud-rain';color='text-blue-400';desc='æœ‰é›¨';} document.getElementById('location-name').innerText=loc; document.getElementById('weather-temp').innerText=`${temp}Â°`; document.getElementById('weather-desc').innerText=desc; document.getElementById('weather-icon').className=`ph-fill ${icon} text-4xl ${color}`; document.getElementById('weather-humidity').innerText=`æ¿•åº¦ ${humidity}%`; document.getElementById('weather-wind').innerText=`é¢¨é€Ÿ ${wind}km/h`; document.getElementById('mobile-weather-temp').innerText=loc==='æœªå®šä½'?'å®šä½':`${temp}Â°`; document.getElementById('mobile-weather-icon').className=`ph-fill ${loc==='æœªå®šä½'?'ph-navigation-arrow':icon} ${color}`; }
        function toggleTodo(id){ const t=appState.todos.find(x=>x.id===id); if(t){t.done=!t.done;renderTodos();} }
        function deleteTodo(id){ appState.todos=appState.todos.filter(x=>x.id!==id); renderTodos(); }
        function deleteNote(id){ appState.notes=appState.notes.filter(x=>x.id!==id); renderNotes(); }
        function addTodoManually(){ const t=prompt("ä»»å‹™"); if(t){appState.todos.push({id:Date.now(),text:t,done:false,time:'æ‰‹å‹•'});renderTodos();} }
        function addNoteManually(){ const t=prompt("æ¨™é¡Œ"),c=prompt("å…§å®¹"); if(t&&c){appState.notes.push({id:Date.now(),title:t,content:c,date:new Date().toLocaleDateString()});renderNotes();} }
        function switchTab(id){ ['dashboard','schedule','notes'].forEach(t=>document.getElementById(`view-${t}`).classList.add('hidden')); document.getElementById(`view-${id}`).classList.remove('hidden'); document.getElementById(`view-${id}`).classList.add('flex'); document.querySelectorAll('.nav-item').forEach(b=>{b.className='nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 transition-all';}); const active=document.getElementById(`nav-${id}`); if(active)active.className='nav-item flex items-center space-x-3 w-full p-4 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg transition-all'; }
        function openSettings(){document.getElementById('settings-modal').classList.remove('hidden');}
        function closeSettings(){document.getElementById('settings-modal').classList.add('hidden');}
        function saveKeys(){ appState.keys.gemini=document.getElementById('key-gemini').value.trim(); appState.keys.cerebras=document.getElementById('key-cerebras').value.trim(); appState.keys.openai=document.getElementById('key-openai').value.trim(); appState.keys.grok=document.getElementById('key-grok').value.trim(); localStorage.setItem('nova_key_gemini',appState.keys.gemini); localStorage.setItem('nova_key_cerebras',appState.keys.cerebras); localStorage.setItem('nova_key_openai',appState.keys.openai); localStorage.setItem('nova_key_grok',appState.keys.grok); appState.detectedGeminiModel=null; closeSettings(); addMessage("è¨­å®šå·²å„²å­˜", 'system'); }
        function setModel(m){ appState.currentModel=m; updateModelUI(); }
        function updateModelUI(){ const conf=MODEL_CONFIG[appState.currentModel]; document.getElementById('status-name').innerText=conf.name; document.getElementById('status-icon').className=`ph-fill ${conf.icon} text-lg ${conf.color}`; document.querySelectorAll('.model-pill').forEach(b=>{ b.className = `model-pill px-2 py-1 rounded text-[10px] font-bold ${b.dataset.model===appState.currentModel ? `${conf.bg} text-white` : 'bg-slate-800 text-slate-400'}`; }); document.getElementById('input-wrapper').className = `flex items-center bg-slate-950 rounded-xl px-2 py-2 border transition-colors border-slate-700 focus-within:border-${appState.currentModel==='gemini'?'blue':appState.currentModel==='cerebras'?'orange':appState.currentModel==='gpt'?'emerald':'slate'}-500`; const badge=document.getElementById('web-search-badge'); const searchBtn=document.getElementById('search-toggle-btn'); const hint=document.getElementById('search-hint'); if(appState.isSearchEnabled){searchBtn.classList.add('text-blue-400','bg-blue-900/30');searchBtn.classList.remove('text-slate-500');if(badge)badge.classList.remove('hidden');if(hint)hint.classList.remove('hidden');}else{searchBtn.classList.remove('text-blue-400','bg-blue-900/30');searchBtn.classList.add('text-slate-500');if(badge)badge.classList.add('hidden');if(hint)hint.classList.add('hidden');} if(appState.currentModel!=='gemini'&&appState.isSearchEnabled){setModel('gemini');} }
        function toggleMobileMenu(){document.getElementById('mobile-menu').classList.toggle('hidden');}
        function escapeHtml(t){return t?t.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">"):""}
    </script>
</body>
</html>

